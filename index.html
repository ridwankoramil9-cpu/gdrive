<!DOCTYPE html>
<!-- 
  ============================================================================
  G-DRIVE ULTIMATE PRO - FRONTEND
  VERSION: 19.4 (Matched with Perfected Copy Replace Logic)
  ============================================================================
-->
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>G-Drive Ultimate Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/tsparticles@2.11.0/tsparticles.bundle.min.js"></script>
    
    <style>
        :root { --primary: #00d2ff; --glass-bg: rgba(20, 20, 30, 0.85); --input-bg: rgba(0, 0, 0, 0.5); }
        body { font-family: 'Poppins', sans-serif; background: #0f0c29; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; padding: 20px; color: #fff; }
        #tsparticles { position: absolute; width: 100%; height: 100%; top: 0; left: 0; z-index: 0; }
        .container { position: relative; z-index: 1; background: var(--glass-bg); padding: 2.5rem; border-radius: 20px; box-shadow: 0 8px 32px 0 rgba(0,0,0,0.5); width: 100%; max-width: 680px; }
        h1 { font-size: 2rem; margin-bottom: 0.5rem; text-align: center; color: var(--primary); }
        .tab-nav { display: flex; gap: 10px; margin-bottom: 25px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px; }
        .tab-btn { background: transparent; border: none; color: #888; font-weight: 600; padding: 10px; cursor: pointer; flex: 1; }
        .tab-btn.active { color: var(--primary); border-bottom: 2px solid var(--primary); }
        input, textarea, select { width: 100%; padding: 12px; background: var(--input-bg); border: 1px solid #444; border-radius: 10px; color: white; margin-bottom: 15px; box-sizing: border-box; }
        button.main-btn { width: 100%; padding: 15px; border-radius: 10px; border: none; background: linear-gradient(45deg, #00d2ff, #3a7bd5); color: #fff; font-weight: 700; cursor: pointer; }
        button.main-btn.stop-mode { background: linear-gradient(45deg, #ff4757, #ff6b81); }
        .log-area { margin-top: 20px; max-height: 150px; overflow-y: auto; background: rgba(0,0,0,0.3); padding: 15px; border-radius: 10px; font-size: 0.8rem; font-family: monospace; }
        .picker-item { padding: 10px; cursor: pointer; border-bottom: 1px solid #333; } .picker-item:hover { background: #333; }
        
        .check-table { width:100%; border-collapse:collapse; margin-top:10px; font-size:0.9rem; }
        .check-table td { padding:8px; border-bottom:1px solid rgba(255,255,255,0.1); }
        .check-table td:first-child { font-weight:bold; color:#00d2ff; width:100px; }
        
        .remote-badge { display:none; background:rgba(46,213,115,0.15); border:1px solid #2ed573; color:#2ed573; padding:10px; border-radius:8px; text-align:center; margin-bottom:10px; cursor:pointer; }
    </style>
</head>
<body>
<div id="tsparticles"></div>

<div class="container">
    <h1>G-Drive Ultimate</h1>
    <p style="text-align:center; color:#aaa; font-size:0.8rem; margin-bottom:20px;">Full Integrated System (v19.4)</p>
    
    <div class="tab-nav">
        <button class="tab-btn active" onclick="switchTab('clone')">â˜ï¸ Clone</button>
        <button class="tab-btn" onclick="switchTab('upload')">ğŸ“¤ Upload</button>
        <button class="tab-btn" onclick="switchTab('search')">ğŸ” Search</button>
    </div>

    <input type="password" id="accessPin" placeholder="PIN Keamanan">

    <div id="panelClone">
        <label>Link Sumber</label>
        <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
            <div>
                <button onclick="openSavedItems()" style="padding:5px 10px; background:#e1b12c; border:none; border-radius:5px; color:white; font-size:0.7rem;">ğŸ“‚ Saved</button>
                <button onclick="saveCurrentLink()" style="padding:5px 10px; background:#0984e3; border:none; border-radius:5px; color:white; font-size:0.7rem;">ğŸ’¾ Save Link</button>
            </div>
            <button onclick="checkSmartLink()" style="background:#6c5ce7; border:none; padding:5px 15px; border-radius:5px; color:white; font-weight:bold; box-shadow:0 0 10px rgba(108,92,231,0.3);">ğŸ” Smart Check</button>
        </div>
        
        <div id="remoteDetectedPanel" class="remote-badge" onclick="openRemoteSourcePicker()">ğŸ“¡ Server Remote Terdeteksi!</div>
        
        <textarea id="folderUrls" placeholder="Paste link folder/file atau URL Script (Akun B) di sini..." style="height:100px; font-family:monospace;"></textarea>
        
        <label>Folder Tujuan</label>
        <div style="display:flex; gap:10px;">
            <input type="text" id="destUrl" placeholder="Link/ID Tujuan">
            <button onclick="openDestPicker('clone')" style="width:auto; padding:0 20px; background:#6c5ce7; border:none; border-radius:5px; color:white;">ğŸ“‚</button>
        </div>

        <label>Mode Copy</label>
        <select id="duplicateMode">
            <option value="copy_duplicate">Duplikat (Default)</option>
            <option value="copy_replace">Replace jika ada (Perfected)</option>
            <option value="copy_skip">Skip jika ada</option>
            <option value="rename_duplicate">Rename Sumber</option>
        </select>

        <div style="margin-bottom:15px; display:flex; align-items:center; justify-content:space-between;">
            <label style="margin:0;"><input type="checkbox" id="bgToggle"> Run in Background</label>
            <span style="font-size:0.8rem; color:#00d2ff; cursor:pointer;" onclick="toggleAdvanced()">âš™ï¸ Advanced</span>
        </div>
        
        <div id="advSec" style="display:none; margin-bottom:15px; padding:10px; background:rgba(0,0,0,0.2); border-radius:10px;">
            <input type="text" id="emailNotif" placeholder="Email Notifikasi" style="margin-bottom:5px;">
            <div style="display:flex; gap:5px;">
                <input type="text" id="schedLabel" placeholder="Nama Jadwal" style="margin:0;">
                <button onclick="createSchedule()" style="background:#20bf6b; border:none; color:white; border-radius:5px; width:60px;">+ Add</button>
            </div>
            <div style="text-align:right; margin-top:5px; font-size:0.8rem; cursor:pointer; color:#aaa;" onclick="showScheduleList()">ğŸ“… Lihat Jadwal</div>
        </div>

        <button class="main-btn" id="btnAction" onclick="handleMainButton()">Mulai Cloning ğŸš€</button>
    </div>

    <!-- Panel Upload & Search -->
    <div id="panelUpload" style="display:none;">
        <div style="border:2px dashed #00d2ff; padding:30px; text-align:center; border-radius:10px; margin-bottom:10px; cursor:pointer;" onclick="document.getElementById('fileInput').click()">
            <span style="font-size:2rem;">â˜ï¸</span><br>Pilih File
        </div>
        <input type="file" id="fileInput" multiple style="display:none;" onchange="handleFileSelect(this)">
        <div id="uploadList" style="text-align:center; color:#aaa; font-size:0.8rem; margin-bottom:10px;"></div>
        
        <label>Tujuan</label>
        <div style="display:flex; gap:10px;">
            <input type="text" id="uploadDestId" placeholder="ID Tujuan">
            <button onclick="openDestPicker('upload')" style="width:auto; padding:0 20px; background:#6c5ce7; border:none; border-radius:5px; color:white;">ğŸ“‚</button>
        </div>
        <div id="uploadTargetLabel" style="display:none; color:#f4b400; font-size:0.8rem;">âš ï¸ Remote Target</div>
        
        <button class="main-btn" id="btnUploadNow" onclick="startUpload()" disabled>Upload ğŸ“¤</button>
    </div>

    <div id="panelSearch" style="display:none;">
        <div style="display:flex; gap:10px;">
            <input type="text" id="searchLocName" placeholder="All Drive" readonly style="background:#333;">
            <input type="hidden" id="searchLocId" value="root">
            <button onclick="openDestPicker('search_source')" style="width:auto; padding:0 15px; background:#6c5ce7; border:none; border-radius:5px; color:white;">ğŸ“‚</button>
        </div>
        <div style="display:flex; gap:10px;">
            <input type="text" id="searchInput" placeholder="Nama file..." onkeypress="if(event.key==='Enter') searchDrive()">
            <button onclick="searchDrive()" style="width:auto; padding:0 20px; background:#00d2ff; border:none; border-radius:5px; color:white;">ğŸ”</button>
        </div>
        <div id="searchResults" style="margin-top:15px; max-height:300px; overflow-y:auto;"></div>
    </div>

    <div class="log-area" id="logArea">System Ready...</div>
</div>

<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzVMco1a7VA7GkY6OyxFm239RXZlqMsTUy9kheMJthucelNETE9Zu9B9jqMB9mgyWbr/exec"; 
    let isProcessing = false; let stopSignal = false; let uploadTargetUrl = SCRIPT_URL; 
    let detectedRemoteUrl = null; let selectedRemoteSourceItems = []; let activePickerMode = 'clone';

    function switchTab(m) {
        document.querySelectorAll('#panelClone, #panelUpload, #panelSearch').forEach(el=>el.style.display='none');
        document.getElementById('panel'+m.charAt(0).toUpperCase()+m.slice(1)).style.display='block';
        document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
        event.target.classList.add('active');
    }
    
    function toggleAdvanced() { const el = document.getElementById('advSec'); el.style.display = el.style.display==='block'?'none':'block'; }

    async function handleMainButton() {
        const btn = document.getElementById('btnAction');
        if (isProcessing) {
            stopSignal = true; btn.innerText = "â³ Menghentikan..."; btn.disabled = true;
            if(document.getElementById('bgToggle').checked) await fetch(SCRIPT_URL, {method:'POST', body:JSON.stringify({action:'stop_background', pin:document.getElementById('accessPin').value})});
        } else { startCloning(); }
    }

    async function startCloning() {
        const urls = document.getElementById('folderUrls').value.split('\n').filter(u=>u);
        const pin = document.getElementById('accessPin').value;
        if(!urls.length || !pin) return Swal.fire('Error','Data kurang','error');

        isProcessing = true; stopSignal = false;
        const btn = document.getElementById('btnAction'); btn.innerHTML = "â›” STOP PROSES"; btn.classList.add('stop-mode');
        
        const config = { mode: document.getElementById('duplicateMode').value, destUrl: document.getElementById('destUrl').value, email: document.getElementById('emailNotif').value };
        addLog("ğŸ”„ Start...", "info");

        try {
            if (document.getElementById('bgToggle').checked) {
                await fetch(SCRIPT_URL, {method:'POST', body:JSON.stringify({action:'start_background_multi', pin:pin, urls:urls, ...config})});
                addLog("âœ… Background Started.", "success");
            } else {
                for(let url of urls) {
                    if(stopSignal) break;
                    const res = await fetch(SCRIPT_URL, {method:'POST', body:JSON.stringify({action:'initialize', pin:pin, url:url, ...config})});
                    const d = await res.json();
                    if(d.status==='success') await processJob(d.jobId, pin);
                    else addLog("âŒ Init Error: "+d.message, "error");
                }
            }
        } catch(e) { addLog("Err: "+e.message, "error"); }
        finally {
            if(!document.getElementById('bgToggle').checked || stopSignal) {
                isProcessing = false; btn.innerHTML = "Mulai Cloning ğŸš€"; btn.classList.remove('stop-mode'); btn.disabled = false;
                addLog("ğŸ Selesai.", "success");
            }
        }
    }

    async function processJob(jobId, pin) {
        let done = false;
        while(!done && !stopSignal) {
            const res = await fetch(SCRIPT_URL, {method:'POST', body:JSON.stringify({action:'process_batch', jobId:jobId, pin:pin})});
            const d = await res.json();
            if(d.status!=='success' || d.action==='complete') done=true;
            if(d.progress) addLog(`â³ Progress: ${d.progress.processed}/${d.progress.total}`, 'info');
            if(d.processedList) d.processedList.forEach(i=>addLog(`ğŸ“„ ${i.name} (${i.status})`, i.status==='success'?'success':'error'));
        }
    }

    function addLog(m,t){const l=document.getElementById('logArea');l.innerHTML+=`<div style="color:${t==='success'?'#2ed573':t==='error'?'#ff4757':'#fff'}">${m}</div>`;l.scrollTop=l.scrollHeight;}
    
    // --- SMART CHECK ---
    async function checkSmartLink(d=false){
        const u=document.getElementById('folderUrls').value.match(/https?:\/\/(drive|docs)\.google\.com\/[-\w\/.]+/); 
        const p=document.getElementById('accessPin').value; 
        if(!u||!p)return Swal.fire('Err','Link/PIN?','error'); 
        Swal.fire({title:d?'Deep Scanning...':'Checking...', didOpen:()=>Swal.showLoading(), background:'#1a1a2e', color:'#fff'});
        
        try {
            const r=await fetch(SCRIPT_URL,{method:'POST',body:JSON.stringify({action:'check_stats',url:u[0],pin:p,deepScan:d})}); 
            const res=await r.json(); 
            if(res.status==='success') {
                let html = `<div style="text-align:left; background:rgba(255,255,255,0.1); padding:10px; border-radius:5px;">
                    <h3>${res.type==='folder'?'ğŸ“':'ğŸ“„'} ${res.name}</h3>
                    <table class="check-table">
                        <tr><td>Owner</td><td>${res.ownerEmail}</td></tr>
                        <tr><td>Access</td><td>${res.access}</td></tr>
                        <tr><td>Size</td><td>${res.stats.size}</td></tr>
                    </table>
                    ${res.type==='folder'&&!d ? '<br><button onclick="checkSmartLink(true)" style="width:100%; padding:8px; background:#f0932b; border:none; color:white; border-radius:5px; cursor:pointer;">ğŸ•µï¸ Deep Scan Size</button>' : ''}
                </div>`;
                Swal.fire({title:'Info', html:html, background:'#1a1a2e', color:'#fff', showCancelButton:true, confirmButtonText:'Clone Now'}).then((r)=>{if(r.isConfirmed) handleMainButton();});
            } else Swal.fire('Err',res.message,'error');
        } catch(e) { Swal.fire('Err',e.message,'error'); }
    }

    // --- PICKERS & REMOTE LOGIC ---
    function openDestPicker(m){activePickerMode=m;Swal.fire({title:'Pilih Tujuan',html:`<div class="picker-tabs"><div class="picker-tab active" id="tabLocal" onclick="switchDestTab('local')">Local</div><div class="picker-tab" id="tabRemote" onclick="switchDestTab('remote')">Remote</div></div><div id="destPickerContent" style="min-height:200px;">Loading...</div>`,background:'#1a1a2e',color:'#fff',didOpen:()=>{switchDestTab('local');}});}
    window.switchDestTab=(t)=>{document.getElementById('tabLocal').className=(t==='local'?'picker-tab active':'picker-tab');document.getElementById('tabRemote').className=(t==='remote'?'picker-tab active':'picker-tab');if(t==='local')loadLocalPicker('root');else loadSavedRemotes();};
    
    // Remote Detection
    document.getElementById('folderUrls').addEventListener('input', ()=>{
        const m = document.getElementById('folderUrls').value.match(/https:\/\/script\.google\.com\/macros\/s\/[a-zA-Z0-9_-]+\/exec/i);
        document.getElementById('remoteDetectedPanel').style.display = m ? 'block' : 'none';
        if(m) detectedRemoteUrl = m[0];
    });
    
    // --- LOADERS (Minified for standard features) ---
    async function loadLocalPicker(pid){const c=document.getElementById('destPickerContent');c.innerHTML='Loading...';const r=await fetch(SCRIPT_URL,{method:'POST',body:JSON.stringify({action:'browse_folders',parentId:pid,pin:document.getElementById('accessPin').value})});const d=await r.json();if(d.status==='success'){let h=`<div><b>${d.currentName}</b> ${d.parentId?`<span onclick="loadLocalPicker('${d.parentId}')" style="cursor:pointer;color:yellow;">â¬…</span>`:''}</div>`;d.folders.forEach(f=>{h+=`<div class="picker-item" onclick="loadLocalPicker('${f.id}')">ğŸ“ ${f.name}</div>`});h+=`<button onclick="selectDest('${d.currentId}','${d.currentName}',false)" style="margin-top:10px;width:100%;padding:5px;background:#0984e3;border:none;color:white;">Pilih Ini</button>`;c.innerHTML=h;}else c.innerText=d.message;}
    async function loadSavedRemotes(){const c=document.getElementById('destPickerContent');const r=await fetch(SCRIPT_URL,{method:'POST',body:JSON.stringify({action:'get_remote_accounts',pin:document.getElementById('accessPin').value})});const d=await r.json();let h='';d.list.forEach(i=>{if(i.type==='server')h+=`<div class="picker-item" onclick="browseRemote('${i.url}')">â˜ï¸ ${i.label}</div>`});c.innerHTML=h;}
    async function browseRemote(u,pid='root'){const c=document.getElementById('destPickerContent');c.innerHTML='Loading...';const r=await fetch(u,{method:'POST',body:JSON.stringify({action:'browse_remote',parentId:pid})});const d=await r.json();if(d.status==='success'){let h=`<div><b>${d.currentName}</b> ${d.parentId?`<span onclick="browseRemote('${u}','${d.parentId}')" style="cursor:pointer;color:yellow;">â¬…</span>`:''}</div>`;d.items.forEach(f=>{if(f.type==='folder')h+=`<div class="picker-item" onclick="browseRemote('${u}','${f.id}')">ğŸ“ ${f.name}</div>`});h+=`<button onclick="selectDest('${u}','${d.currentName}',true,'${d.currentId}')" style="margin-top:10px;width:100%;padding:5px;background:#f0932b;border:none;color:white;">Pilih Remote Ini</button>`;c.innerHTML=h;}}
    
    async function selectDest(val, name, isRemote, remoteId){
        Swal.close();
        if(activePickerMode==='clone'){
            if(isRemote){
                const r = await fetch(SCRIPT_URL,{method:'POST',body:JSON.stringify({action:'connect_remote_dest',pin:document.getElementById('accessPin').value,targetUrl:val,targetId:remoteId})});
                const d = await r.json();
                if(d.status==='success') document.getElementById('destUrl').value = d.folderUrl;
            } else {
                document.getElementById('destUrl').value = `https://drive.google.com/drive/folders/${val}`;
            }
        } else if(activePickerMode==='upload'){
            if(isRemote) { uploadTargetUrl=val; document.getElementById('uploadDestId').value=remoteId; document.getElementById('uploadTargetLabel').style.display='block'; }
            else { uploadTargetUrl=SCRIPT_URL; document.getElementById('uploadDestId').value=val; document.getElementById('uploadTargetLabel').style.display='none'; }
        } else {
            document.getElementById('searchLocId').value = val; document.getElementById('searchLocName').value = name;
        }
        Swal.fire('Set', name, 'success');
    }

    // --- UPLOAD ---
    function handleFileSelect(i){selectedFiles=Array.from(i.files);document.getElementById('uploadList').innerHTML=selectedFiles.map(f=>`<div>ğŸ“„ ${f.name}</div>`).join('');document.getElementById('btnUploadNow').disabled=!selectedFiles.length;}
    async function startUpload(){addLog("Upload...","info");const pin=document.getElementById('accessPin').value;for(let f of selectedFiles){const b64=await new Promise(r=>{const rd=new FileReader();rd.readAsDataURL(f);rd.onload=()=>r(rd.result)});await fetch(uploadTargetUrl,{method:'POST',body:JSON.stringify({action:'direct_upload',pin:pin,fileName:f.name,mimeType:f.type,fileData:b64,destId:document.getElementById('uploadDestId').value})});addLog("âœ… "+f.name,"success");}}

    // --- SEARCH ---
    async function searchDrive(){
        const q=document.getElementById('searchInput').value; 
        document.getElementById('searchResults').innerHTML='Searching...';
        const r=await fetch(SCRIPT_URL,{method:'POST',body:JSON.stringify({action:'search_drive',query:q,pin:document.getElementById('accessPin').value,parentId:document.getElementById('searchLocId').value})});
        const d=await r.json();
        let h='';
        if(d.results) d.results.forEach(f=>{h+=`<div class="search-item" style="border-bottom:1px solid #333; padding:5px; display:flex; justify-content:space-between;"><div>${f.mimeType==='folder'?'ğŸ“':'ğŸ“„'} ${f.name}<br><small>${f.size}</small></div><button onclick="addToQueue('${f.url}','${f.name.replace(/'/g,"")}')" style="background:#2ed573;border:none;color:white;">+</button></div>`});
        document.getElementById('searchResults').innerHTML = h || 'No results';
    }
    function addToQueue(u,n){const t=document.getElementById('folderUrls');t.value+=(t.value?'\n':'')+u;switchTab('clone');Swal.fire('Added',n,'success');}

    // --- OTHER UTILS (Saved/Schedule) ---
    async function openSavedItems(){const r=await fetch(SCRIPT_URL,{method:'POST',body:JSON.stringify({action:'get_remote_accounts',pin:document.getElementById('accessPin').value})});const d=await r.json();let h='';d.list.forEach(i=>{h+=`<div class="picker-item" onclick="document.getElementById('folderUrls').value+='\\n${i.url}';Swal.close()">ğŸ”— ${i.label}</div>`});Swal.fire({title:'Saved',html:h});}
    async function saveCurrentLink(){const u=document.getElementById('folderUrls').value.split('\n')[0];const{value:l}=await Swal.fire({title:'Label',input:'text'});if(l)fetch(SCRIPT_URL,{method:'POST',body:JSON.stringify({action:'save_remote_account',pin:document.getElementById('accessPin').value,targetUrl:u,label:l})});}
    
    // Initial
    tsParticles.load("tsparticles", { fpsLimit: 60, particles: { number: { value: 30 }, color: { value: "#ffffff" }, opacity: { value: 0.1 }, size: { value: 3 }, move: { enable: true, speed: 0.5 } } });
</script>
</body>
</html>
