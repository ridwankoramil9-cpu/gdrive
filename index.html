<!DOCTYPE html>
<!-- 
  ============================================================================
  G-DRIVE ULTIMATE PRO - FRONTEND
  VERSION: 20.4 (FINAL: Timer, ETA, Stop Button, & Full Features)
  ============================================================================
-->
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>G-Drive Ultimate Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <!-- External Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/tsparticles@2.11.0/tsparticles.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <style>
        /* --- CORE THEME --- */
        :root {
            --primary: #00d2ff; 
            --secondary: #ff00de;
            --glass-bg: rgba(20, 20, 30, 0.85); 
            --glass-border: rgba(255, 255, 255, 0.1);
            --text-color: #ffffff; 
            --input-bg: rgba(0, 0, 0, 0.5);
        }
        body {
            font-family: 'Poppins', sans-serif;
            background: #0f0c29; 
            background: linear-gradient(to right, #24243e, #302b63, #0f0c29);
            display: flex; justify-content: center; align-items: center; 
            min-height: 100vh; margin: 0; padding: 20px; 
            color: var(--text-color); overflow-x: hidden; position: relative;
        }
        #tsparticles { position: absolute; width: 100%; height: 100%; top: 0; left: 0; z-index: 0; }
        
        /* --- LOGIN OVERLAY --- */
        #loginOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(15, 12, 41, 0.98); z-index: 9999; 
            display: flex; justify-content: center; align-items: center; 
            backdrop-filter: blur(10px);
        }
        .login-box {
            background: rgba(255, 255, 255, 0.05); padding: 40px; border-radius: 20px; 
            border: 1px solid rgba(255, 255, 255, 0.1); text-align: center; width: 350px;
            box-shadow: 0 0 30px rgba(0, 210, 255, 0.2);
        }
        
        /* --- MAIN CONTAINER --- */
        .container {
            position: relative; z-index: 1; background: var(--glass-bg);
            backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            padding: 2.5rem; border-radius: 20px; border: 1px solid var(--glass-border);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.5); width: 100%; max-width: 680px;
            display: none; /* Hidden by default until login */
        }
        
        h1 {
            font-size: 2rem; margin-bottom: 0.5rem; text-align: center;
            background: linear-gradient(to right, #00d2ff, #ff00de, #f4b400); 
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            font-weight: 700;
        }
        
        /* --- TABS --- */
        .tab-nav { display: flex; gap: 10px; margin-bottom: 25px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px; }
        .tab-btn {
            background: transparent; border: none; color: #888; font-weight: 600; 
            padding: 10px 15px; cursor: pointer; transition: 0.3s; 
            font-size: 0.9rem; border-bottom: 2px solid transparent; flex: 1;
        }
        .tab-btn.active { color: #00d2ff; border-bottom-color: #00d2ff; background: rgba(0,210,255,0.05); }

        /* --- INPUTS & BUTTONS --- */
        label { display: block; margin-bottom: 0.5rem; color: #d1d8e0; font-size: 0.85rem; font-weight: 500; }
        input, textarea, select {
            width: 100%; padding: 12px 15px; background: var(--input-bg);
            border: 1px solid var(--glass-border); border-radius: 10px;
            font-size: 0.9rem; color: white; box-sizing: border-box; margin-bottom: 15px;
        }
        
        button.main-btn {
            width: 100%; padding: 15px; border-radius: 10px; border: none;
            background: linear-gradient(45deg, #00d2ff, #3a7bd5); color: #fff;
            font-weight: 700; cursor: pointer; transition: 0.3s; text-transform: uppercase;
            font-size: 1rem; letter-spacing: 1px;
        }
        button.main-btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0, 210, 255, 0.3); }
        button.main-btn.stop-mode {
            background: linear-gradient(45deg, #ff4757, #ff6b81);
            box-shadow: 0 5px 15px rgba(255, 71, 87, 0.3);
        }

        /* --- STATS BAR (NEW) --- */
        .stats-bar {
            display: none; background: rgba(255,255,255,0.08); padding: 12px;
            border-radius: 10px; margin-bottom: 15px; font-size: 0.85rem;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .stats-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-family: monospace; }
        .progress-track { height: 8px; background: #444; border-radius: 4px; overflow: hidden; }
        .progress-fill { height: 100%; background: #2ed573; width: 0%; transition: width 0.5s ease; }

        /* --- UTILS --- */
        .remote-badge { display: none; width: 100%; padding: 10px; box-sizing: border-box; background: rgba(46, 213, 115, 0.15); border: 1px solid #2ed573; color: #2ed573; border-radius: 8px; margin-bottom: 15px; cursor: pointer; text-align: center; font-weight: bold; font-size: 0.85rem; }
        
        .check-table { width:100%; border-collapse:collapse; margin-top:10px; font-size:0.9rem; }
        .check-table td { padding:8px; border-bottom:1px solid rgba(255,255,255,0.1); }
        .check-table td:first-child { font-weight:bold; color:#00d2ff; width:100px; }
        
        .log-area { margin-top: 20px; max-height: 150px; overflow-y: auto; background: rgba(0,0,0,0.3); padding: 15px; border-radius: 10px; font-size: 0.8rem; font-family: monospace; border: 1px solid rgba(255,255,255,0.05); }
        
        /* Picker Modal */
        .picker-header { display: flex; justify-content: space-between; padding-bottom: 10px; border-bottom: 1px solid #444; margin-bottom: 10px; }
        .picker-item { padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.1); cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .picker-item:hover { background: rgba(255,255,255,0.1); }
        .btn-del-picker { background: rgba(255, 71, 87, 0.2); border: 1px solid #ff4757; color: #ff4757; padding: 4px 8px; border-radius: 5px; cursor: pointer; font-size: 0.8rem; }
        .picker-tabs { display: flex; gap: 10px; margin-bottom: 10px; }
        .picker-tab { padding: 5px 10px; cursor: pointer; border-radius: 5px; color: #888; }
        .picker-tab.active { background: #00d2ff; color: white; font-weight: bold; }

        ::-webkit-scrollbar { width: 6px; } 
        ::-webkit-scrollbar-thumb { background: #444; border-radius: 10px; }
    </style>
</head>
<body>

<div id="tsparticles"></div>

<!-- 1. LOGIN SYSTEM -->
<div id="loginOverlay">
    <div class="login-box">
        <h2 style="color:#00d2ff; margin-bottom:15px;">üîê G-Drive Pro</h2>
        <input type="password" id="gatePinInput" placeholder="PIN" style="text-align:center; font-size:1.5rem; letter-spacing:5px; background:rgba(0,0,0,0.5); color:white; border:1px solid #444; padding:15px; border-radius:10px; width:100%;" onkeypress="if(event.key==='Enter') unlockSite()">
        <button onclick="unlockSite()" class="main-btn" style="margin-top:10px;">MASUK</button>
    </div>
</div>

<!-- 2. MAIN APP -->
<div class="container" id="mainContainer">
    <h1>G-Drive Ultimate</h1>
    <p style="text-align:center; color:#aaa; font-size:0.8rem; margin-bottom:20px;">Full Integrated System (v20.4)</p>
    
    <!-- TAB NAVIGATION -->
    <div class="tab-nav">
        <button class="tab-btn active" id="btnTabClone" onclick="switchTab('clone')">‚òÅÔ∏è Clone</button>
        <button class="tab-btn" id="btnTabUpload" onclick="switchTab('upload')">üì§ Upload</button>
        <button class="tab-btn" id="btnTabSearch" onclick="switchTab('search')">üîç Cari File</button>
    </div>

    <!-- Hidden Input for Session PIN -->
    <input type="hidden" id="accessPin">

    <!-- PANEL CLONE -->
    <div id="panelClone">
        <label>Link Sumber</label>
        <div style="display:flex; justify-content:space-between; margin-bottom:8px; align-items:center;">
           <div style="display:flex; gap:5px;">
               <button onclick="openSavedItems()" style="font-size:0.75rem; background:#e1b12c; border:none; padding:5px 10px; border-radius:5px; cursor:pointer; color:white;">üìÇ Saved</button>
               <button onclick="saveCurrentLink()" style="font-size:0.75rem; background:#0984e3; border:none; padding:5px 10px; border-radius:5px; cursor:pointer; color:white;">üíæ Save</button>
           </div>
           <button onclick="checkSmartLink()" style="font-size:0.75rem; background:#6c5ce7; border:none; padding:5px 15px; border-radius:5px; cursor:pointer; color:white; font-weight:bold; box-shadow:0 0 10px rgba(108, 92, 231, 0.4);">üîç Smart Check</button>
        </div>
        
        <div id="remoteDetectedPanel" class="remote-badge" onclick="openRemoteSourcePicker()">üì° Server Remote Terdeteksi! Klik untuk Jelajah</div>

        <textarea id="folderUrls" placeholder="Paste link folder/file atau URL Script (Akun B) di sini..." style="height:100px; font-family:monospace;"></textarea>
        
        <label>Folder Tujuan</label>
        <div style="display:flex; gap:10px; margin-bottom:15px;">
            <input type="text" id="destUrl" placeholder="Link/ID Folder tujuan (Default)" style="margin-bottom:0;">
            <button onclick="openDestPicker('clone')" style="background:#6c5ce7; border:none; width:50px; border-radius:10px; cursor:pointer; color:white;">üìÇ</button>
        </div>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
            <label style="margin:0;">Mode Copy</label>
            <span style="font-size:0.8rem; color:#00d2ff; cursor:pointer;" onclick="toggleAdvanced()">‚öôÔ∏è Opsi Lanjutan</span>
        </div>
        
        <select id="duplicateMode">
            <option value="copy_duplicate">Duplikat (Default)</option>
            <option value="copy_replace">Replace jika ada (Recommended)</option>
            <option value="copy_skip">Skip jika ada</option>
            <option value="rename_duplicate">Rename Sumber</option>
        </select>

        <div id="advSec" style="display:none; background:rgba(0,0,0,0.2); padding:15px; border-radius:10px; margin-bottom:15px;">
            <div style="margin-bottom:10px;">
                <input type="checkbox" id="bgToggle"> <label style="display:inline;">Run in Background (Server Process)</label>
            </div>
            <input type="text" id="emailNotif" placeholder="Email untuk Notifikasi">
            
            <label>Jadwal Otomatis</label>
            <div style="display:flex; gap:5px;">
               <input type="text" id="schedLabel" placeholder="Label Jadwal" style="margin:0;">
               <button style="background:#20bf6b; border:none; color:white; border-radius:5px; padding:0 15px;" onclick="createSchedule()">+ Add</button>
            </div>
            <div style="margin-top:5px; text-align:right; font-size:0.8rem; color:#aaa; cursor:pointer;" onclick="showScheduleList()">üìÖ Lihat Daftar Jadwal</div>
        </div>

        <button class="main-btn" id="btnAction" onclick="handleMainButton()">Mulai Cloning üöÄ</button>
    </div>

    <!-- PANEL UPLOAD -->
    <div id="panelUpload" style="display:none;">
        <div class="upload-box" onclick="document.getElementById('fileInput').click()" style="border:2px dashed #00d2ff; padding:30px; text-align:center; border-radius:15px; margin-bottom:15px; cursor:pointer;">
            <span style="font-size:3rem;">‚òÅÔ∏è</span>
            <p style="margin-top:10px;">Klik untuk Pilih File</p>
            <input type="file" id="fileInput" style="display:none" multiple onchange="handleFileSelect(this)">
        </div>
        <div id="uploadList" style="margin-bottom:15px; font-size:0.85rem; color:#aaa; text-align:center;"></div>
        
        <label>Tujuan Upload</label>
        <div style="display:flex; gap:10px; margin-bottom:5px;">
            <input type="text" id="uploadDestId" placeholder="ID/Link Folder (Default: Root)" style="margin-bottom:0;">
            <button onclick="openDestPicker('upload')" style="background:#6c5ce7; border:none; width:50px; border-radius:10px; cursor:pointer; color:white;">üìÇ</button>
        </div>
        <div id="uploadTargetLabel" style="font-size:0.8rem; color:#f4b400; margin-bottom:15px; display:none;">‚ö†Ô∏è Target: Remote Server</div>
        
        <button class="main-btn" id="btnUploadNow" onclick="startUpload()" disabled>Upload File üì§</button>
    </div>

    <!-- PANEL SEARCH -->
    <div id="panelSearch" style="display:none;">
        <label>Lokasi Pencarian</label>
        <div style="display:flex; gap:10px; margin-bottom:15px;">
            <input type="text" id="searchLocName" placeholder="Seluruh Drive" readonly style="background:#333; margin-bottom:0;">
            <input type="hidden" id="searchLocId" value="root">
            <button onclick="openDestPicker('search_source')" style="background:#6c5ce7; border:none; padding:0 15px; border-radius:10px; cursor:pointer; color:white;">Filter</button>
            <button onclick="resetSearchLoc()" style="background:#ff4757; border:none; padding:0 10px; border-radius:10px; cursor:pointer; color:white;">Reset</button>
        </div>

        <div style="display:flex; gap:10px; margin-bottom:15px;">
            <input type="text" id="searchInput" placeholder="Nama file..." style="margin-bottom:0;" onkeypress="if(event.key==='Enter') searchDrive()">
            <button onclick="searchDrive()" style="background:#00d2ff; border:none; padding:0 20px; border-radius:10px; cursor:pointer; color:white; font-weight:bold;">Cari</button>
        </div>
        
        <div id="searchResults" class="search-results"></div>
    </div>

    <!-- NEW: STATS BAR (Timer & ETA) -->
    <div id="statsBar" class="stats-bar">
        <div class="stats-row">
            <span id="timerEl">‚è±Ô∏è 00:00:00</span>
            <span id="speedEl">‚ö° 0 file/s</span>
            <span id="etaEl">‚è≥ Est: --:--</span>
        </div>
        <div class="progress-track"><div id="progressBar" class="progress-fill"></div></div>
        <div style="text-align:right; font-size:0.7rem; color:#aaa; margin-top:2px;" id="progressText">0%</div>
    </div>

    <!-- LOGGING -->
    <div class="log-area" id="logArea">System Ready...</div>
</div>

<script>
    // --- KONFIGURASI ---
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzVMco1a7VA7GkY6OyxFm239RXZlqMsTUy9kheMJthucelNETE9Zu9B9jqMB9mgyWbr/exec"; 
    
    let activePickerMode = 'clone';
    let detectedRemoteUrl = null;
    let selectedRemoteSourceItems = [];
    let uploadTargetUrl = SCRIPT_URL; 
    let isProcessing = false; 
    let stopSignal = false;
    let selectedFiles = [];
    
    // Timer Variables
    let jobStartTime = 0;
    let timerInterval = null;

    // --- UI LOGIC ---
    function switchTab(mode) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('btnTab' + mode.charAt(0).toUpperCase() + mode.slice(1)).classList.add('active');
        ['clone', 'upload', 'search'].forEach(m => document.getElementById('panel'+m.charAt(0).toUpperCase()+m.slice(1)).style.display = (m===mode?'block':'none'));
    }
    
    function toggleAdvanced() {
        const sec = document.getElementById('advSec');
        sec.style.display = (sec.style.display === 'block') ? 'none' : 'block';
    }

    async function unlockSite() {
        const pin = document.getElementById('gatePinInput').value;
        if(!pin) return Swal.fire('Error', 'Masukkan PIN', 'warning');
        
        document.querySelector('#loginOverlay h2').innerText = "Memverifikasi...";
        try {
            const res = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action:'verify_pin', pin: pin }) });
            const d = await res.json();
            
            if(d.status === 'success') {
                document.getElementById('accessPin').value = pin;
                document.getElementById('loginOverlay').style.display = 'none';
                document.getElementById('mainContainer').style.display = 'block';
                document.getElementById('mainContainer').classList.add('visible');
            } else {
                document.querySelector('#loginOverlay h2').innerText = "Gagal";
                Swal.fire('Akses Ditolak', 'PIN Salah!', 'error');
                document.querySelector('#loginOverlay h2').innerText = "üîê G-Drive Pro";
            }
        } catch(e) { Swal.fire('Error', 'Koneksi Gagal: '+e.message, 'error'); }
    }

    async function handleMainButton() {
        const btn = document.getElementById('btnAction');
        if (isProcessing) {
            stopSignal = true; btn.innerText = "‚è≥ Menghentikan..."; btn.disabled = true;
            if(document.getElementById('bgToggle').checked) {
                 await fetch(SCRIPT_URL, { method:'POST', body: JSON.stringify({ action:'stop_background', pin:document.getElementById('accessPin').value }) });
                 addLog("üì° Sinyal Stop Background dikirim...", "warning");
            } else { addLog("üõë Stop diminta...", "warning"); }
        } else { startCloning(); }
    }

    // --- CLONING LOGIC ---
    async function startCloning() {
        const urls = document.getElementById('folderUrls').value.split('\n').filter(u=>u);
        const pin = document.getElementById('accessPin').value;
        if(urls.length===0) return Swal.fire('Warning', 'Link kosong', 'warning');
        
        isProcessing = true; stopSignal = false;
        const btn = document.getElementById('btnAction');
        btn.innerHTML = "‚õî STOP PROSES"; btn.classList.add('stop-mode');
        
        // Reset Timer
        jobStartTime = Date.now();
        document.getElementById('statsBar').style.display = 'block';
        if(timerInterval) clearInterval(timerInterval);
        timerInterval = setInterval(updateTimerDisplay, 1000);
        updateTimerDisplay();
        
        const config = { mode: document.getElementById('duplicateMode').value, destUrl: document.getElementById('destUrl').value, email: document.getElementById('emailNotif').value };
        addLog("üîÑ Memulai Proses...", "info");
        
        try {
            if (document.getElementById('bgToggle').checked) {
                 await fetch(SCRIPT_URL, { method:'POST', body: JSON.stringify({ action:'start_background_multi', pin:pin, urls:urls, ...config }) });
                 addLog("‚úÖ Background Started. Boleh tutup tab.", "success");
            } else {
                for(let url of urls) {
                    if(stopSignal) break;
                    const res = await fetch(SCRIPT_URL, { method:'POST', body: JSON.stringify({ action:'initialize', pin:pin, url:url, ...config }) });
                    const d = await res.json();
                    if(d.status === 'success') {
                         addLog(`‚úÖ Init: ${d.sourceName}`, 'success');
                         await processJob(d.jobId, pin);
                    } else addLog(`‚ùå Gagal: ${d.message}`, 'error');
                }
            }
        } catch(e) { addLog("Err: " + e.message, "error"); } 
        finally {
            if(!document.getElementById('bgToggle').checked || stopSignal) {
                isProcessing = false; btn.innerHTML = "Mulai Cloning üöÄ"; btn.classList.remove('stop-mode'); btn.disabled = false;
                clearInterval(timerInterval);
                addLog("üèÅ Selesai.", stopSignal?"warning":"success");
            }
        }
    }

    function updateTimerDisplay() {
        let diff = Math.floor((Date.now() - jobStartTime) / 1000);
        let h = Math.floor(diff / 3600).toString().padStart(2,'0');
        let m = Math.floor((diff % 3600) / 60).toString().padStart(2,'0');
        let s = Math.floor(diff % 60).toString().padStart(2,'0');
        document.getElementById('timerEl').innerText = `‚è±Ô∏è ${h}:${m}:${s}`;
    }

    async function processJob(jobId, pin) {
        let done = false;
        while(!done && !stopSignal) {
            const res = await fetch(SCRIPT_URL, { method:'POST', body: JSON.stringify({ action:'process_batch', jobId:jobId, pin:pin }) });
            const d = await res.json();
            if(d.status !== 'success' || d.action === 'complete') done = true;
            
            // Stats Update
            if(d.progress) {
                let p = d.progress;
                let pct = Math.round((p.processed / p.total) * 100);
                document.getElementById('progressBar').style.width = pct + '%';
                document.getElementById('progressText').innerText = `${p.processed} / ${p.total} (${pct}%)`;
                
                let elapsedSec = (Date.now() - jobStartTime) / 1000;
                let rate = elapsedSec > 0 ? (p.processed / elapsedSec) : 0;
                let remaining = p.total - p.processed;
                let eta = rate > 0 ? Math.floor(remaining / rate) : 0;
                
                let eh = Math.floor(eta / 3600).toString().padStart(2,'0');
                let em = Math.floor((eta % 3600) / 60).toString().padStart(2,'0');
                let es = Math.floor(eta % 60).toString().padStart(2,'0');
                
                document.getElementById('speedEl').innerText = `‚ö° ${rate.toFixed(1)} f/s`;
                document.getElementById('etaEl').innerText = `‚è≥ Est: ${eh}:${em}:${es}`;
                
                addLog(`‚è≥ Processing...`, 'info');
            }
            
            if(d.processedList) d.processedList.forEach(i => addLog(`üìÑ ${i.name} (${i.status})`, i.status==='success'?'success':'error'));
        }
    }

    // --- SMART CHECK ---
    async function checkSmartLink(isDeep = false) {
        const url = document.getElementById('folderUrls').value.match(/https?:\/\/(drive|docs)\.google\.com\/[-\w\/.]+/);
        const pin = document.getElementById('accessPin').value;
        if (!url) return Swal.fire('Error', 'Link tidak valid', 'error');
        
        Swal.fire({ title: isDeep?'Deep Scanning...':'Checking...', didOpen:()=>Swal.showLoading(), background:'#1a1a2e', color:'#fff' });
        try {
            const res = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'check_stats', url: url[0], pin: pin, deepScan: isDeep }) });
            const d = await res.json();
            if (d.status === 'success') {
                let html = `<div style="text-align:left; background:rgba(255,255,255,0.1); padding:10px; border-radius:5px;">
                    <h3>${d.type==='folder'?'üìÅ':'üìÑ'} ${d.name}</h3>
                    <table class="check-table"><tr><td>Owner</td><td>${d.ownerEmail}</td></tr><tr><td>Access</td><td>${d.access}</td></tr><tr><td>Size</td><td style="color:#00d2ff;font-weight:bold;">${d.stats.size}</td></tr>${isDeep?`<tr><td>Files</td><td>${d.stats.files}</td></tr>`:''}</table>
                    ${d.type==='folder'&&!isDeep ? '<br><button onclick="checkSmartLink(true)" style="width:100%; padding:8px; background:#f0932b; border:none; color:white; border-radius:5px; cursor:pointer;">üïµÔ∏è Deep Scan Size</button>' : ''}
                </div>`;
                Swal.fire({title:'Info', html:html, background:'#1a1a2e', color:'#fff', showCancelButton:true, confirmButtonText:'Clone Now'}).then((r)=>{if(r.isConfirmed) startCloning();});
            } else Swal.fire('Gagal', d.message, 'error');
        } catch(e) { Swal.fire('Error', e.message, 'error'); }
    }

    // --- PICKERS ---
    function openDestPicker(m) {
        activePickerMode = m;
        const pin = document.getElementById('accessPin').value;
        if(!pin) return Swal.fire('Error', 'PIN kosong', 'error');
        Swal.fire({
            title: 'Pilih Tujuan',
            html: `<div class="picker-tabs"><div class="picker-tab active" id="tabLocal" onclick="switchDestTab('local')">Local</div><div class="picker-tab" id="tabRemote" onclick="switchDestTab('remote')">Remote</div></div><div id="destPickerContent" style="min-height:250px;">Loading...</div>`,
            showConfirmButton: false, width: '600px', background: '#1a1a2e', color: '#fff',
            didOpen: () => switchDestTab('local')
        });
    }
    
    window.switchDestTab = function(t) {
        document.getElementById('tabLocal').className = (t === 'local') ? 'picker-tab active' : 'picker-tab';
        document.getElementById('tabRemote').className = (t === 'remote') ? 'picker-tab active' : 'picker-tab';
        if (t === 'local') loadLocalPicker('root'); else loadSavedRemotes();
    };

    async function loadLocalPicker(pid) {
        const c = document.getElementById('destPickerContent'); c.innerHTML = 'Loading...';
        const res = await fetch(SCRIPT_URL, { method:'POST', body: JSON.stringify({ action: 'browse_folders', parentId: pid, pin: document.getElementById('accessPin').value }) });
        const d = await res.json();
        if(d.status === 'success') {
            let h = `<div class="picker-header"><b>${d.currentName}</b> ${d.parentId?`<span onclick="loadLocalPicker('${d.parentId}')" style="cursor:pointer;color:#f4b400;">‚¨Ö Back</span>`:''} <span onclick="createLocalFolder('${d.currentId}')" style="cursor:pointer;color:#2ed573;float:right;">+New</span></div><div style="max-height:250px;overflow-y:auto;text-align:left;">`;
            d.folders.forEach(f => { h += `<div class="picker-item"><div style="flex:1;" onclick="loadLocalPicker('${f.id}')">üìÅ ${f.name}</div><button class="btn-del-picker" onclick="event.stopPropagation(); deleteInsidePicker('${f.id}','folder','${f.name.replace(/'/g,"")}','local','${pid}')">üóëÔ∏è</button></div>`; });
            h += `</div><button style="width:100%; padding:10px; margin-top:10px; background:#0984e3; border:none; color:white;" onclick="selectDest('${d.currentId}','${d.currentName}',false)">Pilih Ini</button>`;
            c.innerHTML = h;
        }
    }
    
    async function loadSavedRemotes() {
        const c = document.getElementById('destPickerContent');
        const res = await fetch(SCRIPT_URL, { method:'POST', body: JSON.stringify({ action: 'get_remote_accounts', pin: document.getElementById('accessPin').value }) });
        const d = await res.json();
        let h = '<div style="max-height:250px;overflow-y:auto;text-align:left;">';
        if(d.list) d.list.forEach(i => { if(i.type==='server') h += `<div class="picker-item" onclick="browseRemote('${i.url}','root','${i.label}')">‚òÅÔ∏è ${i.label}</div>`; });
        h += '</div>'; c.innerHTML = h;
    }

    async function browseRemote(url, pid, label) {
        const c = document.getElementById('destPickerContent'); c.innerHTML = 'Loading Remote...';
        try {
            const res = await fetch(url, { method:'POST', body: JSON.stringify({ action:'browse_remote', parentId:pid }) });
            const d = await res.json();
            if(d.status === 'success') {
                let h = `<div class="picker-header"><b>${label} > ${d.currentName}</b> ${d.parentId?`<span onclick="browseRemote('${url}','${d.parentId}','${label}')" style="cursor:pointer;color:#f4b400;">‚¨Ö Back</span>`:`<span onclick="switchDestTab('remote')" style="cursor:pointer;">‚¨Ö List</span>`}</div><div style="max-height:250px;overflow-y:auto;text-align:left;">`;
                d.items.forEach(f => { if(f.type==='folder') h += `<div class="picker-item"><div style="flex:1;" onclick="browseRemote('${url}','${f.id}','${label}')">üìÅ ${f.name}</div><button class="btn-del-picker" onclick="event.stopPropagation(); deleteInsidePicker('${f.id}','folder','${f.name.replace(/'/g,"")}','remote','${pid}','${url}','${label}')">üóëÔ∏è</button></div>`; });
                h += `</div><button style="width:100%; padding:10px; margin-top:10px; background:#f0932b; border:none; color:white;" onclick="selectDest('${url}','${d.currentName}',true,'${d.currentId}','${label}')">Pilih Remote Ini</button>`;
                c.innerHTML = h;
            }
        } catch(e) { c.innerText = "Error: "+e.message; }
    }

    async function selectDest(val, name, isRemote, remoteId, label) {
        Swal.close();
        if (activePickerMode === 'upload') {
            if(isRemote) { uploadTargetUrl=val; document.getElementById('uploadDestId').value=remoteId; document.getElementById('uploadTargetLabel').style.display='block'; document.getElementById('uploadTargetLabel').innerText=`Target: ${label}`; }
            else { uploadTargetUrl=SCRIPT_URL; document.getElementById('uploadDestId').value=val; document.getElementById('uploadTargetLabel').style.display='none'; }
        } else if (activePickerMode === 'clone') {
            if(isRemote) {
                const res = await fetch(SCRIPT_URL, { method:'POST', body: JSON.stringify({ action:'connect_remote_dest', pin:document.getElementById('accessPin').value, targetUrl:val, targetId:remoteId }) });
                const d = await res.json();
                if(d.status === 'success') document.getElementById('destUrl').value = d.folderUrl;
            } else { document.getElementById('destUrl').value = `https://drive.google.com/drive/folders/${val}`; }
        } else {
            document.getElementById('searchLocId').value = val; document.getElementById('searchLocName').value = name;
        }
        Swal.fire('Set', name, 'success');
    }

    async function deleteInsidePicker(id, type, name, mode, pid, rUrl, rLabel) {
        const r = await Swal.fire({ title:'Hapus?', text:name, icon:'warning', showCancelButton:true, confirmButtonColor:'#d33' });
        if(r.isConfirmed) {
            if(mode==='local') { await fetch(SCRIPT_URL, { method:'POST', body: JSON.stringify({ action:'delete_item', id:id, type:type, pin:document.getElementById('accessPin').value }) }); loadLocalPicker(pid); }
            else { await fetch(rUrl, { method:'POST', body: JSON.stringify({ action:'delete_item', id:id, type:type }) }); browseRemote(rUrl, pid, rLabel); }
            Swal.fire('Terhapus','','success');
        }
    }
    
    // --- CREATE FOLDER (UTILS) ---
    async function createLocalFolder(pid) { const {value:n}=await Swal.fire({title:'Nama Folder',input:'text',background:'#1a1a2e',color:'#fff'}); if(n){await fetch(SCRIPT_URL,{method:'POST',body:JSON.stringify({action:'create_folder_tool',parentId:pid,name:n,pin:document.getElementById('accessPin').value})}); loadLocalPicker(pid); }}

    // --- UPLOAD ---
    function handleFileSelect(i) { selectedFiles=Array.from(i.files); document.getElementById('uploadList').innerHTML=selectedFiles.map(f=>`<div>üìÑ ${f.name}</div>`).join(''); document.getElementById('btnUploadNow').disabled=!selectedFiles.length; }
    async function startUpload() {
        const pin = document.getElementById('accessPin').value;
        addLog("üöÄ Uploading...", "info");
        for(let f of selectedFiles) {
            const b64 = await new Promise(r=>{const rd=new FileReader();rd.readAsDataURL(f);rd.onload=()=>r(rd.result)});
            try {
                const res = await fetch(uploadTargetUrl, { method:'POST', body: JSON.stringify({ action:'direct_upload', pin:pin, fileName:f.name, mimeType:f.type, fileData:b64, destId:document.getElementById('uploadDestId').value }) });
                const d = await res.json();
                if(d.status==='success') addLog(`‚úÖ ${f.name}`, 'success'); else addLog(`‚ùå ${d.message}`, 'error');
            } catch(e) { addLog('Err: '+e.message, 'error'); }
        }
    }

    // --- SEARCH ---
    async function searchDrive() {
        const q = document.getElementById('searchInput').value;
        document.getElementById('searchResults').innerHTML = 'Mencari...';
        const res = await fetch(SCRIPT_URL, { method:'POST', body: JSON.stringify({ action:'search_drive', query:q, pin:document.getElementById('accessPin').value, parentId:document.getElementById('searchLocId').value }) });
        const d = await res.json();
        let h = '';
        if(d.results) d.results.forEach(f => { h += `<div class="search-item" style="display:flex;justify-content:space-between;padding:10px;border-bottom:1px solid #444;"><div>${f.mimeType==='folder'?'üìÅ':'üìÑ'} ${f.name}</div><div><button onclick="addToQueue('${f.url}','${f.name.replace(/'/g,"")}')" style="background:#2ed573;border:none;color:white;">+</button></div></div>`; });
        document.getElementById('searchResults').innerHTML = h || 'Tidak ditemukan';
    }

    // --- MISC UTILS ---
    function addLog(m, t) { const l=document.getElementById('logArea'); l.innerHTML+=`<div style="color:${t==='success'?'#2ed573':t==='error'?'#ff4757':'#fff'};">${m}</div>`; l.scrollTop=l.scrollHeight; }
    function addToQueue(u,n) { const t=document.getElementById('folderUrls'); t.value+=(t.value?'\n':'')+u; switchTab('clone'); Swal.fire('Added',n,'success'); }
    function resetSearchLoc() { document.getElementById('searchLocId').value='root'; document.getElementById('searchLocName').value='Seluruh Drive (Default)'; }
    
    // Remote Detection
    document.getElementById('folderUrls').addEventListener('input', ()=>{
        const m = document.getElementById('folderUrls').value.match(/https:\/\/script\.google\.com\/macros\/s\/[a-zA-Z0-9_-]+\/exec/i);
        document.getElementById('remoteDetectedPanel').style.display = m ? 'block' : 'none';
        if(m) detectedRemoteUrl = m[0];
    });
    
    // Saved & Schedule
    async function openSavedItems() { const res=await fetch(SCRIPT_URL,{method:'POST',body:JSON.stringify({action:'get_remote_accounts',pin:document.getElementById('accessPin').value})});const d=await res.json();let h='<div style="max-height:250px;overflow-y:auto;">';if(d.list)d.list.forEach(i=>{h+=`<div class="picker-item" onclick="insertSaved('${i.url}')">üîó ${i.label}</div>`});h+='</div>';Swal.fire({title:'Saved',html:h}); }
    function insertSaved(u) { const t=document.getElementById('folderUrls'); t.value+=(t.value?'\n':'')+u; Swal.close(); }
    async function saveCurrentLink() { const u=document.getElementById('folderUrls').value.split('\n')[0]; const{value:l}=await Swal.fire({title:'Label',input:'text'}); if(l) fetch(SCRIPT_URL,{method:'POST',body:JSON.stringify({action:'save_remote_account',pin:document.getElementById('accessPin').value,targetUrl:u,label:l})}); }
    async function createSchedule() { const lbl=document.getElementById('schedLabel').value; if(!lbl)return; await fetch(SCRIPT_URL,{method:'POST',body:JSON.stringify({action:'add_schedule_item',pin:document.getElementById('accessPin').value,label:lbl,config:{urls:document.getElementById('folderUrls').value.split('\n'),destUrl:document.getElementById('destUrl').value,maxBackups:30}})}); Swal.fire('Success','','success'); }
    async function showScheduleList() { const res=await fetch(SCRIPT_URL,{method:'POST',body:JSON.stringify({action:'get_schedule_list',pin:document.getElementById('accessPin').value})});const d=await res.json();let h='<div style="max-height:200px;overflow-y:auto;">';if(d.list)d.list.forEach(i=>{h+=`<div>${i.label} <button onclick="delSched('${i.id}')" style="color:red;">Del</button></div>`});Swal.fire({title:'Jadwal',html:h}); }
    async function delSched(id) { await fetch(SCRIPT_URL,{method:'POST',body:JSON.stringify({action:'delete_schedule_item',id:id,pin:document.getElementById('accessPin').value})}); Swal.fire('Deleted','','success'); }

    // Init Particles
    tsParticles.load("tsparticles", { fpsLimit: 60, particles: { number: { value: 30 }, color: { value: "#ffffff" }, opacity: { value: 0.1 }, size: { value: 3 }, move: { enable: true, speed: 0.5 } } });
</script>
</body>
</html>
