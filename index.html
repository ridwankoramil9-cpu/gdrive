<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>G-Drive Ultimate v2.3</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/tsparticles@2.11.0/tsparticles.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <style>
        :root {
            --primary: #00d2ff; --secondary: #ff00de;
            --glass-bg: rgba(20, 20, 30, 0.75); --glass-border: rgba(255, 255, 255, 0.1);
            --text-color: #ffffff; --input-bg: rgba(0, 0, 0, 0.5);
        }
        body {
            font-family: 'Poppins', sans-serif;
            background: #0f0c29; background: linear-gradient(to right, #24243e, #302b63, #0f0c29);
            display: flex; justify-content: center; align-items: center; min-height: 100vh;
            margin: 0; padding: 20px; color: var(--text-color); overflow-x: hidden; position: relative;
        }
        #tsparticles { position: absolute; width: 100%; height: 100%; top: 0; left: 0; z-index: 0; }
        
        .container {
            position: relative; z-index: 1; background: var(--glass-bg);
            backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            padding: 2rem; border-radius: 20px; border: 1px solid var(--glass-border);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.5); width: 100%; max-width: 600px;
            animation: fadeIn 0.8s ease-out;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        h1 {
            font-size: 1.8rem; margin-bottom: 0.5rem; text-align: center;
            background: linear-gradient(to right, #00d2ff, #ff00de, #f4b400); 
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            font-weight: 700; text-shadow: 0 0 20px rgba(0, 210, 255, 0.3);
        }
        p.subtitle { text-align: center; color: rgba(255, 255, 255, 0.8); font-size: 0.9rem; margin-bottom: 0.5rem; }

        /* MODE SWITCH */
        .mode-switch-container { display: flex; justify-content: center; margin-bottom: 20px; }
        .mode-switch-wrapper {
            background: rgba(0,0,0,0.3); border-radius: 30px; padding: 4px; display: flex;
            border: 1px solid rgba(255,255,255,0.1); position: relative;
        }
        .mode-btn {
            padding: 8px 25px; border-radius: 25px; border: none; background: transparent;
            color: #aaa; font-weight: 600; cursor: pointer; transition: all 0.3s ease; font-size: 0.9rem;
            z-index: 2; position: relative;
        }
        .mode-btn.active { color: #fff; text-shadow: 0 0 10px rgba(255,255,255,0.5); }
        .mode-highlighter {
            position: absolute; top: 4px; left: 4px; height: calc(100% - 8px); width: 50%;
            background: linear-gradient(90deg, #00d2ff, #3a7bd5); border-radius: 25px;
            transition: transform 0.3s cubic-bezier(0.68, -0.55, 0.27, 1.55); z-index: 1;
        }

        .form-group { margin-bottom: 1.2rem; }
        label { display: block; margin-bottom: 0.6rem; color: #d1d8e0; font-size: 0.85rem; font-weight: 500; }
        
        .header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.6rem; }
        .btn-clear {
            width: auto !important; padding: 4px 10px !important; font-size: 0.75rem !important;
            background: rgba(255, 71, 87, 0.2) !important; border: 1px solid rgba(255, 71, 87, 0.5) !important;
            color: #ff4757 !important; margin: 0 !important; border-radius: 6px !important; 
        }
        .btn-clear:hover { background: rgba(255, 71, 87, 0.4) !important; color: white !important; }

        /* REMOTE DETECTED BADGE */
        .remote-badge {
            display: none; width: 100%; padding: 10px; box-sizing: border-box;
            background: rgba(46, 213, 115, 0.2); border: 1px solid #2ed573; color: #2ed573;
            border-radius: 8px; margin-bottom: 10px; cursor: pointer; text-align: center;
            font-weight: bold; font-size: 0.9rem; transition: all 0.2s;
            animation: pulse 2s infinite;
        }
        .remote-badge:hover { background: rgba(46, 213, 115, 0.4); }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(46, 213, 115, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(46, 213, 115, 0); } 100% { box-shadow: 0 0 0 0 rgba(46, 213, 115, 0); } }

        textarea, input[type="text"], input[type="number"], input[type="email"], input[type="password"] {
            width: 100%; padding: 12px 15px; background: var(--input-bg);
            border: 1px solid var(--glass-border); border-radius: 10px;
            font-size: 0.9rem; color: white; box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }
        textarea:focus, input:focus { outline: none; border-color: var(--primary); }

        .input-group { display: flex; gap: 10px; }
        .btn-picker {
            width: auto !important; white-space: nowrap; background: #6c5ce7;
            padding: 0 20px !important; display: flex; align-items: center; justify-content: center;
        }
        .btn-picker:hover { background: #5649c0; }

        select {
            width: 100%; padding: 12px 15px; background: var(--input-bg);
            border: 1px solid var(--glass-border); border-radius: 10px;
            font-size: 0.9rem; color: white; box-sizing: border-box; cursor: pointer;
            appearance: none; -webkit-appearance: none;
            background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%2300d2ff%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E");
            background-repeat: no-repeat; background-position: right 15px top 50%; background-size: 12px auto;
        }
        option { background: #1a1a2e; color: white; }
        optgroup { background: #000; color: #f4b400; font-weight: bold; }
        
        /* ADVANCED & SCHEDULE */
        .advanced-section {
            background: rgba(0,0,0,0.2); border-radius: 10px; padding: 15px; margin-bottom: 20px;
            border: 1px solid rgba(255,255,255,0.05); display: none; 
            animation: slideDown 0.3s ease-out;
        }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        .two-col { display: flex; gap: 15px; } .col { flex: 1; }
        .toggle-container { display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 10px; }
        .toggle-label { font-size: 0.9rem; font-weight: 600; color: #00d2ff; }
        .switch { position: relative; display: inline-block; width: 50px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #2ed573; } input:checked + .slider:before { transform: translateX(26px); }

        .schedule-box { border: 1px dashed rgba(255, 255, 255, 0.3); padding: 15px; border-radius: 10px; margin-top: 15px; }
        /* SCHEDULE LIST STYLING RESTORED */
        .schedule-list { margin-top: 15px; max-height: 200px; overflow-y: auto; }
        .schedule-item { 
            background: rgba(255,255,255,0.05); border-bottom: 1px solid rgba(255,255,255,0.1); 
            padding: 10px; display: flex; justify-content: space-between; align-items: center; 
            font-size: 0.8rem;
        }
        .schedule-info { flex: 1; padding-right: 10px; }
        .schedule-name { font-weight: bold; color: #00d2ff; display: block; margin-bottom: 2px;}
        .schedule-meta { color: #888; font-size: 0.75rem; }
        
        .sched-btn-group { display: flex; gap: 5px; }
        .btn-del-sched { 
            background: #ff4757 !important; width: auto !important; padding: 5px 10px !important; 
            font-size: 0.7rem !important; border-radius: 5px; color:white; border:none; cursor:pointer;
        }
        .btn-detail-sched { 
            background: #3498db !important; width: auto !important; padding: 5px 10px !important; 
            font-size: 0.7rem !important; border-radius: 5px; color:white; border:none; cursor:pointer;
        }
        
        .btn-group { display: flex; gap: 10px; }
        button { width: 100%; border: none; padding: 14px; border-radius: 10px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: transform 0.2s; text-transform: uppercase; letter-spacing: 1px; color: white; }
        #submitBtn { background: linear-gradient(45deg, #00d2ff, #3a7bd5, #ff00de); background-size: 200% 200%; animation: gradientAnim 3s ease infinite; }
        #checkBtn { background: #6c5ce7; }
        #stopBtn { background: #ff4757; display: none; }
        @keyframes gradientAnim { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        button:hover { transform: translateY(-2px); }
        .sheet-btn { background: #109869 !important; color: white !important; margin-top: 10px; display: block; width: 100%; text-decoration: none; text-align: center; padding: 10px; border-radius: 5px; font-weight: bold; }

        .progress-wrapper { margin-top: 20px; display: none; }
        .progress-container { width: 100%; height: 8px; background-color: rgba(255, 255, 255, 0.1); border-radius: 10px; overflow: hidden; margin-top: 5px;}
        .progress-bar { height: 100%; width: 0%; background: linear-gradient(90deg, #f4b400, #ff00de, #00d2ff); border-radius: 10px; transition: width 0.4s ease; }
        .log-area { margin-top: 15px; max-height: 200px; overflow-y: auto; background: rgba(0,0,0,0.3); border-radius: 8px; padding: 10px; font-size: 0.8rem; font-family: 'Consolas', monospace; display: none; border: 1px solid rgba(255,255,255,0.05); }
        .log-item { padding: 4px 0; border-bottom: 1px solid rgba(255,255,255,0.05); display: flex; gap: 8px; align-items:center; }
        .log-icon { flex-shrink: 0; width: 20px; text-align: center; }
        .log-size { font-size: 0.7em; color: #888; margin-left: auto; padding-left: 10px; }
        .log-success { color: #00d2ff; } .log-error { color: #ff4757; } .log-info { color: #ddd; } .log-warning { color: #ffa502; font-weight: bold; } 
        
        /* PICKER STYLES */
        .picker-container { text-align: left; max-height: 300px; overflow-y: auto; }
        .picker-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; border-bottom: 1px solid #444; padding-bottom: 5px; }
        .picker-item { padding: 8px; border-radius: 5px; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: background 0.2s; border: 1px solid transparent; color: #ddd; }
        .picker-item:hover { background: rgba(255,255,255,0.1); }
        .picker-item.selected { background: rgba(0, 210, 255, 0.2); border-color: #00d2ff; }
        .picker-checkbox { width: 18px; height: 18px; accent-color: #00d2ff; cursor: pointer; }

        .result-box { text-align: left; background: #222; padding: 15px; border-radius: 10px; margin-bottom: 10px; border: 1px solid #333; }
        .result-title { color: #00d2ff; font-weight: bold; margin-bottom: 5px; font-size: 0.95rem; }
        .result-info { font-size: 0.85rem; color: #ccc; }
        .hidden-input { display: none; margin-top: 10px; }
        
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: rgba(0,0,0,0.1); }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 3px; }
        .swal-table { width: 100%; font-size: 0.9em; margin-top: 10px; border-collapse: collapse; }
        .swal-table td { padding: 5px; border-bottom: 1px solid #333; color: #ddd; text-align: left; }
        .swal-table td:last-child { text-align: right; font-weight: bold; color: #fff; }
    </style>
</head>
<body>

<div id="tsparticles"></div>

<div class="container">
    <h1>G-Drive Ultimate</h1>
    <p class="subtitle">Smart Filter & Secure Cloning</p>
    
    <div class="mode-switch-container">
        <div class="mode-switch-wrapper">
            <div class="mode-highlighter" id="modeHighlighter"></div>
            <button class="mode-btn active" id="btnSimple" onclick="setMode('simple')">Simple</button>
            <button class="mode-btn" id="btnAdvance" onclick="setMode('advance')">Advance</button>
        </div>
    </div>
    
    <div class="form-group">
        <label for="accessPin">PIN Akses (Wajib)</label>
        <input type="password" id="accessPin" placeholder="Masukkan PIN Rahasia Anda" value="12345">
    </div>
    
    <!-- SOURCE AREA WITH SMART DETECTION -->
    <div class="form-group">
        <div class="header-row">
            <label for="folderUrls">Daftar Link Sumber</label>
            <button id="clearInputBtn" class="btn-clear">Clear</button>
        </div>
        
        <!-- NEW: SMART BUTTON -->
        <div id="remoteDetectedPanel" class="remote-badge" onclick="openRemotePicker()">
            üì° Server Remote Terdeteksi! Klik untuk Jelajah
        </div>

        <textarea id="folderUrls" placeholder="Paste Link GDrive atau Link WebApp Script Akun B di sini..."></textarea>
    </div>

    <div class="form-group">
        <label for="destUrl">Folder Tujuan (Opsional)</label>
        <div class="input-group">
            <input type="text" id="destUrl" placeholder="Link folder tujuan (jika kosong = default)">
            <button type="button" class="btn-picker" id="browseBtn">üìÇ Pilih</button>
        </div>
    </div>

    <div class="form-group">
        <label for="newFolderName">Buat Folder Baru (Sub-folder)</label>
        <input type="text" id="newFolderName" placeholder="Contoh: Backup Akun B">
    </div>

    <!-- ADVANCED & SCHEDULE -->
    <div class="advanced-section" id="advancedSection">
        <div style="font-size:0.8rem; color:#f4b400; margin-bottom:10px;">üõ†Ô∏è Pengaturan Advance</div>
        
        <div class="form-group">
            <label for="duplicateMode">Metode Duplikasi:</label>
            <select id="duplicateMode" onchange="toggleRenameInput()">
                <optgroup label="üîµ Mode Copy (File Sumber Tetap Aman)">
                    <option value="copy_duplicate">Copy & Duplikat (Default)</option>
                    <option value="copy_skip">Copy & Skip (Jika file ada, lewati)</option>
                    <option value="copy_replace">Copy & Replace (Timpa file lama)</option>
                </optgroup>
                <optgroup label="‚úèÔ∏è Mode Rename (Ganti Nama Sumber)">
                    <option value="rename_duplicate">Copy & Rename Sumber</option>
                    <option value="rename_skip">Copy & Rename (Skip jika target ada)</option>
                    <option value="rename_replace">Copy & Rename (Replace jika target ada)</option>
                </optgroup>
            </select>
            <div id="renameInputContainer" class="hidden-input">
                <input type="text" id="renamePrefix" placeholder="Prefix: [MOVED] ">
            </div>
        </div>
        
        <div class="two-col">
            <div class="col"><label>Max Size (MB)</label><input type="number" id="maxSize" placeholder="0 = Unlimited"></div>
            <div class="col"><label>Ignore Ext</label><input type="text" id="ignoredExt" placeholder="mp4, exe"></div>
        </div>

        <div class="form-group">
            <label>Email Notifikasi</label>
            <input type="email" id="emailNotif" placeholder="email@anda.com">
        </div>
        
        <div class="toggle-container">
            <span class="toggle-label">Run in Background</span>
            <label class="switch"><input type="checkbox" id="bgToggle"><span class="slider"></span></label>
        </div>

        <!-- SCHEDULE -->
        <div class="schedule-box">
            <div class="toggle-label" style="margin-bottom:10px;">üìÖ Manajemen Jadwal</div>
            <input type="text" id="scheduleLabel" placeholder="Nama Jadwal" style="margin-bottom:5px;">
            <input type="number" id="maxBackups" value="30" placeholder="Max Retensi" style="margin-bottom:5px;">
            <button id="addScheduleBtn" type="button" style="padding:10px; font-size:0.8rem; background:#10ac84;">‚ûï Tambah Jadwal</button>
            <div class="schedule-list" id="scheduleListContainer">Memuat...</div>
            <button type="button" onclick="refreshScheduleList()" style="background:none; color:#00d2ff; font-size:0.8rem; margin-top:5px; padding:0;">üîÑ Refresh</button>
        </div>
    </div>

    <div class="btn-group">
        <button id="checkBtn">üîç Cek Link</button>
        <button id="submitBtn">Mulai Proses</button>
        <button id="stopBtn">STOP üõë</button>
    </div>

    <div class="progress-wrapper" id="progressWrapper">
        <div style="text-align:center; color:#f4b400; font-weight:bold; margin-bottom:10px;" id="globalStatus">Menunggu...</div>
        <div style="text-align:center; font-family:monospace; color:white; font-size:1.2rem; margin-bottom:10px;" id="timerDisplay">00:00:00</div>
        <div style="display:flex; justify-content:space-between; font-size:0.8rem;">
            <span id="progressText">Progress...</span><span id="progressPercent">0%</span>
        </div>
        <div class="progress-container"><div class="progress-bar" id="progressBar"></div></div>
        <div class="log-area" id="logArea"></div>
    </div>
</div>

<script>
    // URL SCRIPT AKUN A (SERVER UTAMA)
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzVMco1a7VA7GkY6OyxFm239RXZlqMsTUy9kheMJthucelNETE9Zu9B9jqMB9mgyWbr/exec"; 
    
    // GANTI DENGAN 5 AGAR LEBIH CEPAT
    const CONCURRENCY_LIMIT = 5;

    // UI Variables
    const submitBtn = document.getElementById('submitBtn');
    const checkBtn = document.getElementById('checkBtn');
    const stopBtn = document.getElementById('stopBtn');
    const folderUrlsInput = document.getElementById('folderUrls');
    const remoteDetectedPanel = document.getElementById('remoteDetectedPanel');
    const destUrlInput = document.getElementById('destUrl');
    const accessPinInput = document.getElementById('accessPin');
    const progressWrapper = document.getElementById('progressWrapper');
    const progressBar = document.getElementById('progressBar');
    const logArea = document.getElementById('logArea');
    const globalStatus = document.getElementById('globalStatus');
    const timerDisplay = document.getElementById('timerDisplay');
    
    let detectedRemoteUrl = null;
    let selectedRemoteFolders = []; // Temporary storage for multi-select
    let currentSessionLogs = [];
    let isStopRequested = false;
    let timerInterval;
    let activeSchedules = []; // GLOBAL VAR FOR SCHEDULE DETAILS

    // --- SMART DETECTION LOGIC ---
    folderUrlsInput.addEventListener('input', function() {
        const val = this.value;
        const scriptRegex = /https:\/\/script\.google\.com\/macros\/s\/[a-zA-Z0-9_-]+\/exec/;
        const match = val.match(scriptRegex);

        if (match) {
            detectedRemoteUrl = match[0];
            remoteDetectedPanel.style.display = 'block';
            remoteDetectedPanel.innerHTML = `üì° Server Remote Terdeteksi! Klik untuk Jelajah Akun B`;
        } else {
            detectedRemoteUrl = null;
            remoteDetectedPanel.style.display = 'none';
        }
    });

    // --- REMOTE PICKER LOGIC (MULTI SELECT) ---
    window.openRemotePicker = function() {
        if (!detectedRemoteUrl) return;
        selectedRemoteFolders = []; // Reset selection

        Swal.fire({
            title: 'Jelajah Akun B (Remote)',
            html: `<div id="remotePickerContent"><div style="color:#aaa;">Menghubungi Server B...</div></div>`,
            showConfirmButton: false, showCloseButton: true, width: '600px',
            background: '#1a1a2e', color: '#fff',
            didOpen: () => { loadRemoteContent('root'); }
        });
    };

    async function loadRemoteContent(parentId) {
        const container = document.getElementById('remotePickerContent');
        if(!container) return;
        container.innerHTML = '<div class="swal2-loading" style="display:block;"></div>';

        try {
            const response = await fetch(detectedRemoteUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain;charset=utf-8' }, 
                body: JSON.stringify({ action: 'browse_remote', parentId: parentId })
            });
            const res = await response.json();

            if (res.status === 'success') {
                let html = `
                    <div class="picker-header">
                        <div style="font-size:0.9rem; font-weight:bold; color:#2ed573;">üìÇ ${res.currentName}</div>
                        ${res.parentId ? `<div style="cursor:pointer; color:#f4b400;" onclick="navRemote('${res.parentId}')">‚¨Ö Kembali</div>` : ''}
                    </div>
                    <div class="picker-container">`;

                if (res.items.length === 0) {
                    html += `<div style="padding:20px; text-align:center; color:#666;">Folder kosong</div>`;
                } else {
                    res.items.forEach(f => {
                        // Tentukan Icon & Navigasi berdasarkan Tipe
                        let icon = f.type === 'folder' ? 'üìÅ' : 'üìÑ';
                        let sizeInfo = f.type === 'file' ? `<span style="font-size:0.7em; color:#888; margin-left:5px;">(${f.size})</span>` : '';
                        
                        // Navigasi hanya jalan kalau tipe = folder
                        let navAction = f.type === 'folder' ? `onclick="navRemote('${f.id}')"` : '';
                        let cursorStyle = f.type === 'folder' ? 'cursor:pointer;' : 'cursor:default;';
                        let textColor = f.type === 'folder' ? '#fff' : '#ccc';

                        html += `
                        <div class="picker-item">
                            <input type="checkbox" class="picker-checkbox" value="${f.id}" data-name="${f.name}" data-type="${f.type}" onchange="toggleRemoteSelect(this)">
                            <span style="flex:1; margin-left:10px; ${cursorStyle} color:${textColor};" ${navAction}>
                                ${icon} ${f.name} ${sizeInfo}
                            </span>
                        </div>`;
                    });
                }
                html += `</div>
                <div style="margin-top:15px; display:flex; gap:10px;">
                    <button style="background:#2ed573; padding:10px; font-size:0.9rem;" onclick="confirmRemoteSelection()">‚úÖ Tambahkan (${selectedRemoteFolders.length}) Item Terpilih</button>
                </div>`;
                container.innerHTML = html;
            } else {
                container.innerHTML = `<div style="color:red;">Server B Error: ${res.message}</div>`;
            }
        } catch (e) {
            container.innerHTML = `<div style="color:red;">Koneksi Gagal: ${e.message}<br>Pastikan Script B sudah di-deploy sebagai 'Anyone'.</div>`;
        }
    }

    window.navRemote = (id) => { loadRemoteContent(id); };
    
    window.toggleRemoteSelect = (cb) => {
        const id = cb.value;
        const name = cb.getAttribute('data-name');
        const type = cb.getAttribute('data-type');
        
        if (cb.checked) {
            selectedRemoteFolders.push({ id, name, type });
        } else {
            selectedRemoteFolders = selectedRemoteFolders.filter(item => item.id !== id);
        }
        
        // Update Button Text
        const btn = document.querySelector('#remotePickerContent button');
        if(btn) btn.innerText = `‚úÖ Tambahkan (${selectedRemoteFolders.length}) Item Terpilih`;
    };

    window.confirmRemoteSelection = () => {
        if (selectedRemoteFolders.length === 0) {
            Swal.showValidationMessage('Pilih minimal satu item!');
            return;
        }
        
        // Generate Links based on Type
        let newLinks = selectedRemoteFolders.map(f => {
            if (f.type === 'folder') {
                return `https://drive.google.com/drive/folders/${f.id}`;
            } else {
                // Link File Standar
                return `https://drive.google.com/file/d/${f.id}/view`;
            }
        }).join('\n');
        
        const currentVal = folderUrlsInput.value;
        folderUrlsInput.value = currentVal + (currentVal ? '\n' : '') + newLinks;
        
        Swal.close();
        Swal.fire({ icon: 'success', title: 'Berhasil', text: `${selectedRemoteFolders.length} item ditambahkan ke antrian!` });
    };

    // --- STANDARD PICKER (DESTINATION) ---
    document.getElementById('browseBtn').addEventListener('click', () => {
        const pin = accessPinInput.value;
        if(!pin) { Swal.fire('Error', 'Masukkan PIN Akses!', 'error'); return; }
        
        Swal.fire({
            title: 'Pilih Folder Tujuan (Akun A)',
            html: `<div id="pickerContent">Loading...</div>`,
            showConfirmButton: false, width: '600px', background: '#1a1a2e', color: '#fff',
            didOpen: () => { loadLocalPicker('root', pin); }
        });
    });

    async function loadLocalPicker(parentId, pin) {
        const container = document.getElementById('pickerContent');
        try {
            const res = await sendRequest({ action: 'browse_folders', parentId: parentId, pin: pin });
            if(res.status === 'success') {
                let html = `<div class="picker-header"><div>${res.currentName}</div>${res.parentId?`<div onclick="loadLocalPicker('${res.parentId}','${pin}')" style="cursor:pointer">‚¨Ö Back</div>`:''}</div><div class="picker-container">`;
                res.folders.forEach(f => {
                    html += `<div class="picker-item" onclick="selectLocalDest('${f.id}', '${f.name}')" ondblclick="loadLocalPicker('${f.id}','${pin}')">üìÅ ${f.name}</div>`;
                });
                html += `</div>`;
                container.innerHTML = html;
            } else container.innerText = res.message;
        } catch(e) { container.innerText = e.message; }
    }
    window.selectLocalDest = (id, name) => {
        destUrlInput.value = `https://drive.google.com/drive/folders/${id}`;
        Swal.close();
        destUrlInput.style.borderColor = '#2ed573';
        setTimeout(() => { destUrlInput.style.borderColor = 'rgba(255, 255, 255, 0.1)'; }, 1000);
    };

    // --- CHECK LINK LOGIC (RESTORED) ---
    checkBtn.addEventListener('click', async () => {
        const rawText = folderUrlsInput.value;
        const urls = rawText.split(/[\n,]+/)
                            .map(u => u.trim())
                            .filter(u => u.length > 0 && !u.includes('script.google.com'));
        const pin = accessPinInput.value;

        if (!pin) { Swal.fire({ icon: 'error', title: 'PIN Kosong', text: 'Masukkan PIN akses Anda.' }); return; }
        if (urls.length === 0) { Swal.fire({ icon: 'warning', title: 'Kosong/Remote URL', text: 'Masukkan setidaknya satu link Google Drive (bukan link script).' }); return; }

        Swal.fire({ title: `Memindai ${urls.length} Link...`, text: 'Sedang mengambil data...', allowOutsideClick: false, didOpen: () => { Swal.showLoading(); } });

        let resultsHTML = "";

        for (let i = 0; i < urls.length; i++) {
            try {
                const res = await sendRequest({ action: 'check_stats', url: urls[i], pin: pin });
                
                if (res.status === 'success') {
                    const accessColor = res.canEdit ? '#2ed573' : '#ff4757'; 
                    const accessWeight = res.canEdit ? 'normal' : 'bold';

                    resultsHTML += `
                        <div class="result-box">
                            <div class="result-title">${i+1}. ${res.name} (${res.type === 'folder' ? 'üìÅ Folder' : 'üìÑ File'})</div>
                            <div class="result-info">
                                üìÑ File: ${res.stats.files} | 
                                üíæ Size: <span style="color:#2ed573">${res.stats.size}</span><br>
                                üîí Akses: <span style="color:${accessColor}; font-weight:${accessWeight}">${res.access}</span><br>
                                ü§ñ Running As: <span style="color:#fff">${res.scriptUser}</span><br>
                                üëë Owner File: <span style="color:#ccc">${res.ownerEmail}</span>
                            </div>
                        </div>
                    `;
                } else {
                    resultsHTML += `<div class="result-box" style="border-color:#ff4757"><div class="result-title" style="color:#ff4757">${i+1}. Gagal</div><div class="result-info">${res.message}</div></div>`;
                }
            } catch (e) {
                resultsHTML += `<div class="result-box" style="border-color:#ff4757"><div class="result-title" style="color:#ff4757">${i+1}. Error</div><div class="result-info">${e.message}</div></div>`;
            }
        }

        Swal.fire({
            title: 'üìä Hasil Scan Lengkap',
            html: `<div style="max-height:300px; overflow-y:auto; padding-right:5px;">${resultsHTML}</div>`,
            background: '#111', color: '#fff', confirmButtonText: 'Tutup', width: '600px'
        });
    });

    // --- MAIN PROCESS LOGIC (RESTORED FOREGROUND QUEUE) ---
    document.getElementById('clearInputBtn').addEventListener('click', () => { 
        folderUrlsInput.value = ''; 
        remoteDetectedPanel.style.display = 'none'; 
    });

    submitBtn.addEventListener('click', async () => {
        const rawText = folderUrlsInput.value;
        const urls = rawText.split(/[\n,]+/)
                            .map(u => u.trim())
                            .filter(u => u.startsWith('http') && !u.includes('script.google.com'));

        const pin = accessPinInput.value;
        const destUrl = destUrlInput.value.trim();
        const newFolderName = newFolderNameInput.value.trim();
        
        let renamePrefix = document.getElementById('renamePrefix').value.trim();
        if (renamePrefix === "") renamePrefix = "[MOVED] ";
        if (!renamePrefix.endsWith(" ") && !renamePrefix.endsWith("_") && !renamePrefix.endsWith("-")) renamePrefix += " ";

        if (!pin) { Swal.fire({ icon: 'error', title: 'PIN Kosong', text: 'Masukkan PIN.' }); return; }
        if (urls.length === 0) { Swal.fire({ icon: 'warning', title: 'Kosong', text: 'Tidak ada link Google Drive yang valid untuk diproses.' }); return; }

        const config = {
            mode: document.getElementById('duplicateMode').value,
            destUrl: destUrl,
            newFolderName: newFolderName,
            renamePrefix: renamePrefix, 
            filters: {
                maxSizeMB: parseInt(document.getElementById('maxSize').value) || 0,
                ignoredExt: document.getElementById('ignoredExt').value
            },
            email: document.getElementById('emailNotif').value
        };

        if (config.mode.startsWith('rename_')) {
            const c = await Swal.fire({title:'Konfirmasi Rename?', text:'File sumber akan diganti namanya. Lanjut?', icon:'warning', showCancelButton:true, confirmButtonColor:'#d33', confirmButtonText:'Ya'});
            if (!c.isConfirmed) return;
        }

        isStopRequested = false; 
        setUIState('running'); 
        clearLog(); 
        startTimer();
        currentSessionLogs = []; // Reset Logs

        addLog(`üîê PIN: OK | Mode: ${config.mode.toUpperCase()}`, 'info');

        // Use Background Mode if checked
        if (document.getElementById('bgToggle').checked) {
            try {
                addLog("Mengirim job ke server...", "info");
                const res = await sendRequest({ 
                    action: 'start_background_multi', urls: urls, pin: pin, ...config 
                });
                if(res.status === 'success') {
                    addLog("‚úÖ " + res.message, "success"); globalStatus.textContent = "BERJALAN DI SERVER"; 
                    if (typeof launchConfetti === 'function') launchConfetti();
                    Swal.fire({ icon: 'success', title: 'Started!', text: 'Proses berjalan di background.', confirmButtonText: 'Oke' });
                } else { 
                    addLog("‚ùå Gagal: " + res.message, "error"); setUIState('stopped'); stopTimer(); 
                }
            } catch(e) { addLog("‚ùå Error: " + e.message, "error"); setUIState('stopped'); stopTimer(); }
        } else {
            // Foreground Processing
            await runForegroundQueue(urls, pin, config);
        }
    });

    stopBtn.addEventListener('click', () => { isStopRequested = true; stopBtn.innerText = "Stopping..."; });

    // --- FOREGROUND WORKER (RESTORED) ---
    async function runForegroundQueue(urls, pin, config) {
        let successCount = 0; let failCount = 0; let grandTotalFiles = 0; let grandTotalBytes = 0; let resultLinks = [];

        for (let i = 0; i < urls.length; i++) {
            if (isStopRequested) break;
            const currentUrl = urls[i];
            globalStatus.textContent = `Memproses Link ${i + 1} dari ${urls.length}`;
            updateProgress(0, "Inisialisasi...");

            try {
                addLog(`‚ñ∂ [${i+1}/${urls.length}] Connecting...`, 'info');
                const result = await processSingleFolder(currentUrl, pin, config);
                
                const itemType = result.type === 'file' ? 'File' : 'Folder';
                
                if (result.files > 0 || result.type === 'file') {
                     successCount++;
                     addLog(`‚úÖ Selesai: ${itemType} "${result.name}" (${result.files} processed).`, 'success');
                     if (result.url) resultLinks.push({ name: `${itemType}: ${result.name}`, url: result.url });
                } else {
                     addLog(`‚ö†Ô∏è Selesai: ${result.name} (0 file disalin/kena filter).`, 'info');
                }
                
                grandTotalFiles += result.files; 
                grandTotalBytes += parseBytesToNum(result.sizeStr);

            } catch (error) {
                failCount++; addLog(`‚ùå Gagal: ${error.message}`, 'error');
                if(error.message.includes("PIN")) { setUIState('stopped'); stopTimer(); return; }
            }
        }

        setUIState('stopped'); stopTimer();
        
        if (isStopRequested) {
            addLog("‚õî Proses dihentikan.", "error"); globalStatus.textContent = "DIHENTIKAN";
        } else {
            globalStatus.textContent = "SELESAI"; 
            
            // Send Report
            try {
                const reportRes = await sendRequest({
                    action: 'send_report', pin: pin, email: config.email || "", 
                    urls: urls, stats: { success: successCount, fail: failCount, totalFiles: grandTotalFiles, totalSize: formatBytes(grandTotalBytes) },
                    details: currentSessionLogs 
                });
                if(reportRes.emailStatus === 'sent') addLog("üìß Email terkirim!", "success");
            } catch(e) {}

            if (typeof launchConfetti === 'function') launchConfetti();
            showFinalReport(successCount, failCount, grandTotalFiles, grandTotalBytes, resultLinks);
        }
    }

    async function processSingleFolder(url, pin, config) {
        if (isStopRequested) return { files: 0, sizeStr: "0 B", url: null, type: 'unknown' };
        
        const initRes = await sendRequest({ action: 'initialize', url: url, name: "", pin: pin, ...config });
        if (initRes.status !== 'success') throw new Error(initRes.message);

        const jobId = initRes.jobId; const total = initRes.totalFiles;
        const sourceName = initRes.sourceName || "Item";
        let targetUrl = initRes.targetUrl; 
        const sourceType = initRes.type || 'folder';

        const actionText = sourceType === 'file' ? 'Menyalin File' : 'Menyalin Folder';
        document.getElementById('progressText').textContent = `${actionText}: ${sourceName}`;

        if (total === 0) return { files: 0, sizeStr: "0 B", url: targetUrl, name: sourceName, type: sourceType };

        let finalProcessed = 0; let finalSizeStr = "0 B"; let isFinished = false; let workers = [];
        
        const workerTask = async () => {
            while (!isFinished && !isStopRequested) {
                try {
                    const res = await sendRequest({ action: 'process_batch', jobId: jobId, pin: pin });
                    if (res.status !== 'success') throw new Error(res.message);
                    
                    const p = res.progress;
                    updateProgress(p.percent, `${actionText}: ${p.processed}/${p.total}`);
                    finalProcessed = p.processed; finalSizeStr = p.currentSize;

                    if (res.processedList && res.processedList.length > 0) {
                        res.processedList.forEach(item => {
                            let type = 'success';
                            if(item.status === 'skipped') type = 'skip';
                            if(item.status === 'error') type = 'error';
                            if(item.status === 'warning') type = 'warning'; 
                            
                            if (item.status === 'success' && sourceType === 'file') targetUrl = item.url;
                            
                            let displayInfo = item.info; 
                            if(item.status === 'warning') displayInfo = "‚ö†Ô∏è " + item.info;

                            currentSessionLogs.push({ name: item.name, url: item.url, status: type.toUpperCase(), info: displayInfo });
                            addLogHTML(item.name, item.url, item.size, type, displayInfo);
                        });
                    }
                    if (res.action === 'complete') isFinished = true;
                } catch (e) { await new Promise(r => setTimeout(r, 2000)); }
            }
        };

        for (let k = 0; k < CONCURRENCY_LIMIT; k++) workers.push(workerTask());
        await Promise.all(workers);

        return { files: finalProcessed, sizeStr: finalSizeStr, url: targetUrl, name: sourceName, type: sourceType };
    }

    // --- SCHEDULE LOAD (RESTORED WITH DETAILS) ---
    window.refreshScheduleList = async () => {
        const c = document.getElementById('scheduleListContainer'); c.innerText = "Loading...";
        try {
            const res = await sendRequest({ action: 'get_schedule_list', pin: accessPinInput.value || '0000' });
            if(res.status === 'success') {
                if(res.list && res.list.length > 0) {
                    activeSchedules = res.list; // STORE FOR DETAILS
                    let html = '';
                    res.list.forEach(item => {
                        const lastRun = item.lastRun ? new Date(item.lastRun).toLocaleString() : 'Belum pernah';
                        html += `
                        <div class="schedule-item">
                            <div class="schedule-info">
                                <span class="schedule-name">${item.label}</span>
                                <div class="schedule-meta">Destinasi: ...${item.destUrl.substr(-15)}</div>
                                <div class="schedule-meta">Mode: ${item.mode} | Run Terakhir: ${lastRun}</div>
                            </div>
                            <div class="sched-btn-group">
                                <button class="btn-detail-sched" onclick="viewScheduleDetail('${item.id}')">‚ÑπÔ∏è</button>
                                <button class="btn-del-sched" onclick="delSched('${item.id}')">üóëÔ∏è</button>
                            </div>
                        </div>`;
                    });
                    c.innerHTML = html;
                } else c.innerHTML = '<div style="text-align:center;color:#666;padding:10px;">Belum ada jadwal.</div>';
            } else c.innerText = "Gagal load jadwal.";
        } catch(e) { c.innerText = "Error koneksi."; }
    };

    window.viewScheduleDetail = function(id) {
        const item = activeSchedules.find(s => s.id === id);
        if (!item) return;

        const config = item.config;
        const sourceLinksHtml = config.urls.map((u, i) => `<div>${i+1}. <a href="${u}" target="_blank" style="color:#00d2ff; text-decoration:none;">${u.substring(0,30)}...</a></div>`).join('');
        
        let filterHtml = "Tidak ada filter aktif.";
        if (config.filters && (config.filters.maxSizeMB > 0 || config.filters.ignoredExt)) {
            filterHtml = `Max Size: ${config.filters.maxSizeMB || 'Unlimited'} MB<br>Ignore Ext: ${config.filters.ignoredExt || '-'}`;
        }

        Swal.fire({
            title: `üìã Detail Jadwal`,
            html: `
                <div style="text-align:left; font-size:0.85rem; background:#222; padding:15px; border-radius:8px; border:1px solid #444; max-height:300px; overflow-y:auto;">
                    <div style="margin-bottom:10px;">
                        <strong style="color:#f4b400;">üè∑Ô∏è Label:</strong> ${item.label}
                    </div>
                    <div style="margin-bottom:10px;">
                        <strong style="color:#f4b400;">üîó Link Sumber (${config.urls.length}):</strong>
                        <div style="padding-left:10px; font-size:0.8rem;">${sourceLinksHtml}</div>
                    </div>
                    <div style="margin-bottom:10px;">
                        <strong style="color:#f4b400;">üìÇ Tujuan:</strong><br>
                        <a href="${config.destUrl}" target="_blank" style="color:#00d2ff;">Buka Folder Tujuan</a><br>
                        Sub-folder: ${config.newFolderName || "(Tidak ada)"}
                    </div>
                    <div style="margin-bottom:10px;">
                        <strong style="color:#f4b400;">‚öôÔ∏è Setting:</strong><br>
                        Mode: ${config.mode}<br>
                        Retention (Max): ${config.maxBackups || 30}<br>
                        Email: ${config.email || "-"}
                    </div>
                    <div>
                        <strong style="color:#f4b400;">üîç Filter:</strong><br>
                        ${filterHtml}
                    </div>
                </div>
            `,
            background: '#1a1a2e',
            color: '#fff',
            showConfirmButton: true,
            confirmButtonText: 'Tutup'
        });
    };

    window.delSched = async (id) => {
        if(!confirm('Hapus jadwal ini?')) return;
        await sendRequest({ action: 'delete_schedule_item', id: id, pin: accessPinInput.value });
        refreshScheduleList();
    };
    refreshScheduleList();


    // --- UTILS ---
    async function sendRequest(payload) { 
        const res = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(payload) }); 
        return await res.json(); 
    }
    function setUIState(s) {
        if(s==='running') { submitBtn.style.display='none'; checkBtn.style.display='none'; stopBtn.style.display='block'; progressWrapper.style.display='block'; logArea.style.display='block'; }
        else { submitBtn.style.display='block'; checkBtn.style.display='block'; stopBtn.style.display='none'; stopBtn.innerText="STOP üõë"; }
    }
    function addLog(m, t) { logArea.innerHTML += `<div class="log-item log-${t}"><span class="log-icon">${getIcon(t)}</span><span>${m}</span></div>`; logArea.scrollTop=logArea.scrollHeight; }
    function addLogHTML(name, url, size, type, detailMsg) { 
        const div = document.createElement('div'); div.className = 'log-item log-' + type; 
        const content = url && url !== '#' ? `<a href="${url}" target="_blank">${name}</a>` : name; 
        div.innerHTML = `<span class="log-icon">${getIcon(type)}</span> <span style="flex:1; overflow:hidden; text-overflow:ellipsis;">${content} <span style="font-size:0.8em; opacity:0.8">(${detailMsg})</span></span> <span class="log-size">${size}</span>`; 
        logArea.appendChild(div); logArea.scrollTop = logArea.scrollHeight; 
    }
    function getIcon(type) { if(type === 'success') return '‚úÖ'; if(type === 'error') return '‚ùå'; if(type === 'skip') return '‚è©'; if(type === 'info') return '‚ÑπÔ∏è'; if(type === 'warning') return '‚ö†Ô∏è'; return '‚Ä¢'; }
    function clearLog() { logArea.innerHTML = ''; }
    function updateProgress(p, t) { progressBar.style.width=p+"%"; document.getElementById('progressPercent').innerText=p+"%"; document.getElementById('progressText').innerText=t; }
    function startTimer() { const s = Date.now(); timerInterval = setInterval(() => { const d = Math.floor((Date.now()-s)/1000); timerDisplay.innerText = new Date(d*1000).toISOString().substr(11,8); }, 1000); }
    function stopTimer() { clearInterval(timerInterval); }
    function launchConfetti() { if (typeof confetti !== 'undefined') { var d = 3000; var e = Date.now() + d; var i = setInterval(function() { if (Date.now() > e) return clearInterval(i); confetti({ particleCount: 50, spread: 360, startVelocity: 30, origin: { x: Math.random(), y: Math.random() - 0.2 } }); }, 250); } }
    function formatBytes(b) { if (bytes === 0) return '0 Bytes'; const i = Math.floor(Math.log(b) / Math.log(1024)); return parseFloat((b / Math.pow(1024, i)).toFixed(2)) + ' ' + ['Bytes', 'KB', 'MB', 'GB', 'TB'][i]; }
    function parseBytesToNum(sizeStr) { if (!sizeStr) return 0; const units = { 'Bytes': 1, 'KB': 1024, 'MB': 1024**2, 'GB': 1024**3, 'TB': 1024**4 }; const parts = sizeStr.split(' '); return parseFloat(parts[0]) * (units[parts[1]] || 1); }
    
    function showFinalReport(success, fail, totalFiles, totalBytes, links) {
        let linksHtml = "";
        if (links.length > 0) {
            linksHtml += `<div style="margin-top:15px; border-top:1px solid #333; padding-top:10px; max-height:100px; overflow-y:auto;">`;
            links.forEach(link => { linksHtml += `<div style="margin-bottom:5px;"><a href="${link.url}" target="_blank" style="color:#00d2ff; text-decoration:none;">üîó ${link.name}</a></div>`; });
            linksHtml += `</div>`;
        }
        Swal.fire({
            title: 'üéâ Selesai',
            html: `
                <table class="swal-table">
                    <tr><td>Link Sumber</td><td>${success + fail}</td></tr>
                    <tr><td>Total Item</td><td>${totalFiles}</td></tr>
                    <tr><td>Total Ukuran</td><td>${totalBytes} Bytes (Est)</td></tr>
                    <tr><td>Durasi</td><td>${timerDisplay.textContent}</td></tr>
                </table>${linksHtml}`,
            background: '#111116', color: '#fff', confirmButtonText: 'Tutup'
        });
    }

    // UI Toggles
    function setMode(m) { 
        document.getElementById('advancedSection').style.display = m==='simple'?'none':'block'; 
        document.getElementById('btnSimple').className = m==='simple'?'mode-btn active':'mode-btn';
        document.getElementById('btnAdvance').className = m==='advance'?'mode-btn active':'mode-btn';
        document.getElementById('modeHighlighter').style.transform = m==='simple'?'translateX(0)':'translateX(100%)';
    }
    function toggleRenameInput() { document.getElementById('renameInputContainer').style.display = document.getElementById('duplicateMode').value.startsWith('rename')?'block':'none'; }
    
    // Add Schedule
    document.getElementById('addScheduleBtn').addEventListener('click', async () => {
       const res = await sendRequest({ action: 'add_schedule_item', pin: accessPinInput.value, label: document.getElementById('scheduleLabel').value, config: { urls: folderUrlsInput.value.split('\n'), destUrl: destUrlInput.value, maxBackups: 30 } });
       if(res.status==='success') refreshScheduleList(); else Swal.fire('Error', res.message, 'error');
    });

    // Particles
    tsParticles.load("tsparticles", { fpsLimit: 60, particles: { number: { value: 30 }, color: { value: "#ffffff" }, opacity: { value: 0.2 }, size: { value: 3 }, move: { enable: true, speed: 1 } } });
</script>
</body>
</html>
