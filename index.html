<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>G-Drive Ultimate</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/tsparticles@2.11.0/tsparticles.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <style>
        :root {
            --primary: #00d2ff; --secondary: #ff00de;
            --glass-bg: rgba(20, 20, 30, 0.75); --glass-border: rgba(255, 255, 255, 0.1);
            --text-color: #ffffff; --input-bg: rgba(0, 0, 0, 0.5);
        }
        body {
            font-family: 'Poppins', sans-serif;
            background: #0f0c29; background: linear-gradient(to right, #24243e, #302b63, #0f0c29);
            display: flex; justify-content: center; align-items: center; min-height: 100vh;
            margin: 0; padding: 20px; color: var(--text-color); overflow-x: hidden; position: relative;
        }
        #tsparticles { position: absolute; width: 100%; height: 100%; top: 0; left: 0; z-index: 0; }
        
        .container {
            position: relative; z-index: 1; background: var(--glass-bg);
            backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            padding: 2rem; border-radius: 20px; border: 1px solid var(--glass-border);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.5); width: 100%; max-width: 600px;
            animation: fadeIn 0.8s ease-out;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        h1 {
            font-size: 1.8rem; margin-bottom: 0.5rem; text-align: center;
            background: linear-gradient(to right, #00d2ff, #ff00de, #f4b400); 
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            font-weight: 700; text-shadow: 0 0 20px rgba(0, 210, 255, 0.3);
        }
        p.subtitle { text-align: center; color: rgba(255, 255, 255, 0.8); font-size: 0.9rem; margin-bottom: 0.5rem; }

        /* STATUS BADGE */
        .status-badge-container { text-align: center; margin-bottom: 1.5rem; min-height: 25px; }
        .status-badge {
            display: inline-block; padding: 4px 12px; border-radius: 15px; font-size: 0.75rem; font-weight: 600;
            background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); color: #aaa;
            transition: all 0.3s ease;
        }
        .status-badge.active { background: rgba(46, 213, 115, 0.2); border-color: #2ed573; color: #2ed573; box-shadow: 0 0 10px rgba(46, 213, 115, 0.2); }

        /* MODE TOGGLE SWITCH STYLE */
        .mode-switch-container {
            display: flex; justify-content: center; margin-bottom: 20px;
        }
        .mode-switch-wrapper {
            background: rgba(0,0,0,0.3); border-radius: 30px; padding: 4px; display: flex;
            border: 1px solid rgba(255,255,255,0.1); position: relative;
        }
        .mode-btn {
            padding: 8px 25px; border-radius: 25px; border: none; background: transparent;
            color: #aaa; font-weight: 600; cursor: pointer; transition: all 0.3s ease; font-size: 0.9rem;
            z-index: 2; position: relative;
        }
        .mode-btn.active { color: #fff; text-shadow: 0 0 10px rgba(255,255,255,0.5); }
        .mode-highlighter {
            position: absolute; top: 4px; left: 4px; height: calc(100% - 8px); width: 50%;
            background: linear-gradient(90deg, #00d2ff, #3a7bd5); border-radius: 25px;
            transition: transform 0.3s cubic-bezier(0.68, -0.55, 0.27, 1.55); z-index: 1;
        }

        .form-group { margin-bottom: 1.2rem; }
        label { display: block; margin-bottom: 0.6rem; color: #d1d8e0; font-size: 0.85rem; font-weight: 500; }
        
        .header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.6rem; }
        .btn-clear {
            width: auto !important; padding: 4px 10px !important; font-size: 0.75rem !important;
            background: rgba(255, 71, 87, 0.2) !important; border: 1px solid rgba(255, 71, 87, 0.5) !important;
            color: #ff4757 !important; margin: 0 !important; border-radius: 6px !important; 
        }
        .btn-clear:hover { background: rgba(255, 71, 87, 0.4) !important; color: white !important; }

        textarea, input[type="text"], input[type="number"], input[type="email"], input[type="password"] {
            width: 100%; padding: 12px 15px; background: var(--input-bg);
            border: 1px solid var(--glass-border); border-radius: 10px;
            font-size: 0.9rem; color: white; box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }
        textarea:focus, input:focus { outline: none; border-color: var(--primary); }

        /* Picker Button Style */
        .input-group { display: flex; gap: 10px; }
        .btn-picker {
            width: auto !important; white-space: nowrap; background: #6c5ce7;
            padding: 0 20px !important; display: flex; align-items: center; justify-content: center;
        }
        .btn-picker:hover { background: #5649c0; }

        select {
            width: 100%; padding: 12px 15px; background: var(--input-bg);
            border: 1px solid var(--glass-border); border-radius: 10px;
            font-size: 0.9rem; color: white; box-sizing: border-box;
            font-family: 'Poppins', sans-serif; cursor: pointer;
            appearance: none; -webkit-appearance: none;
            background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%2300d2ff%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E");
            background-repeat: no-repeat; background-position: right 15px top 50%; background-size: 12px auto;
        }
        option { background: #1a1a2e; color: white; }
        optgroup { background: #000; color: #f4b400; font-weight: bold; }

        /* ADVANCED SECTION WRAPPER */
        .advanced-section {
            background: rgba(0,0,0,0.2); border-radius: 10px; padding: 15px; margin-bottom: 20px;
            border: 1px solid rgba(255,255,255,0.05); display: none; /* Hidden by default in Simple Mode */
            animation: slideDown 0.3s ease-out;
        }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        .two-col { display: flex; gap: 15px; }
        .col { flex: 1; }

        .toggle-container {
            display: flex; align-items: center; justify-content: space-between;
            margin-bottom: 15px; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 10px;
        }
        .toggle-label { font-size: 0.9rem; font-weight: 600; color: #00d2ff; }
        .switch { position: relative; display: inline-block; width: 50px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #2ed573; } input:checked + .slider:before { transform: translateX(26px); }

        /* MULTI SCHEDULE SECTION */
        .schedule-box { border: 1px dashed rgba(255, 255, 255, 0.3); padding: 15px; border-radius: 10px; margin-top: 15px; }
        .schedule-title { font-size: 0.9rem; color: #f4b400; font-weight: bold; margin-bottom: 10px; display: flex; align-items: center; gap: 5px; }
        
        #addScheduleBtn { background: #10ac84; padding: 10px; font-size: 0.85rem; width: 100%; margin-top: 5px; }
        #addScheduleBtn:hover { background: #0e9471; }

        /* LIST OF ACTIVE SCHEDULES */
        .schedule-list { margin-top: 15px; max-height: 200px; overflow-y: auto; }
        .schedule-item { 
            background: rgba(255,255,255,0.05); border-bottom: 1px solid rgba(255,255,255,0.1); 
            padding: 10px; display: flex; justify-content: space-between; align-items: center; 
            font-size: 0.8rem;
        }
        .schedule-info { flex: 1; padding-right: 10px; }
        .schedule-name { font-weight: bold; color: #00d2ff; display: block; margin-bottom: 2px;}
        .schedule-meta { color: #888; font-size: 0.75rem; }
        
        .sched-btn-group { display: flex; gap: 5px; }
        .btn-del-sched { 
            background: #ff4757 !important; width: auto !important; padding: 5px 10px !important; 
            font-size: 0.7rem !important; border-radius: 5px; color:white; border:none; cursor:pointer;
        }
        .btn-detail-sched { 
            background: #3498db !important; width: auto !important; padding: 5px 10px !important; 
            font-size: 0.7rem !important; border-radius: 5px; color:white; border:none; cursor:pointer;
        }
        .btn-detail-sched:hover { background: #2980b9 !important; }

        .btn-group { display: flex; gap: 10px; }
        button {
            width: 100%; border: none; padding: 14px; border-radius: 10px;
            font-size: 1rem; font-weight: 600; cursor: pointer;
            transition: transform 0.2s; text-transform: uppercase; letter-spacing: 1px; color: white;
        }
        #submitBtn {
            background: linear-gradient(45deg, #00d2ff, #3a7bd5, #ff00de);
            background-size: 200% 200%; animation: gradientAnim 3s ease infinite;
        }
        #checkBtn { background: #6c5ce7; }
        #stopBtn { background: #ff4757; display: none; }
        
        /* New Quota Button */
        #btnQuota {
            background: #222; border: 1px solid #444; color: #aaa; margin-top: 15px; 
            font-size: 0.8rem; padding: 8px;
        }
        #btnQuota:hover { background: #333; color: white; }

        @keyframes gradientAnim { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        button:hover { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(0,0,0,0.3); }
        button:disabled { background: #444; color: #aaa; cursor: not-allowed; animation: none; transform: none; box-shadow: none;}
        .sheet-btn { background: #109869 !important; color: white !important; margin-top: 10px; display: block; width: 100%; text-decoration: none; text-align: center; padding: 10px; border-radius: 5px; font-weight: bold; }
        .sheet-btn:hover { background: #0c7a54 !important; }

        /* Report Styles */
        .report-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 15px; border-bottom: 1px solid #333; padding-bottom: 15px; }
        .report-stat { background: rgba(255,255,255,0.05); padding: 8px; border-radius: 6px; text-align: center; }
        .report-val { font-size: 1.1rem; font-weight: bold; color: #fff; display: block; }
        .report-lbl { font-size: 0.7rem; color: #aaa; }
        .report-list-container { max-height: 250px; overflow-y: auto; text-align: left; }
        .report-item { padding: 8px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; gap: 10px; }
        .report-item:last-child { border-bottom: none; }
        .report-name { font-size: 0.85rem; color: #ddd; flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .report-status-badge { font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; font-weight: bold; }
        .badge-success { background: rgba(46, 213, 115, 0.2); color: #2ed573; }
        .badge-fail { background: rgba(255, 71, 87, 0.2); color: #ff4757; }
        .badge-skip { background: rgba(255, 165, 2, 0.2); color: #ffa502; }
        .report-link { text-decoration: none; font-size: 1rem; color: #00d2ff; }

        .progress-wrapper { margin-top: 20px; display: none; }
        .global-status { 
            text-align: center; margin-bottom: 5px; font-weight: 600; color: #f4b400; 
            border: 1px solid rgba(244, 180, 0, 0.3); padding: 5px; border-radius: 5px; background: rgba(0,0,0,0.2);
        }
        .timer-display {
            text-align: center; font-family: 'Courier New', Courier, monospace; font-size: 1.3rem; color: #fff;
            margin-bottom: 10px; font-weight: bold; text-shadow: 0 0 10px rgba(0, 210, 255, 0.5); letter-spacing: 2px;
        }
        .progress-container { width: 100%; height: 8px; background-color: rgba(255, 255, 255, 0.1); border-radius: 10px; overflow: hidden; margin-top: 5px;}
        .progress-bar { height: 100%; width: 0%; background: linear-gradient(90deg, #f4b400, #ff00de, #00d2ff); border-radius: 10px; transition: width 0.4s ease; }
        
        .log-area {
            margin-top: 15px; max-height: 200px; overflow-y: auto; 
            background: rgba(0,0,0,0.3); border-radius: 8px; padding: 10px;
            font-size: 0.8rem; font-family: 'Consolas', monospace; display: none;
            border: 1px solid rgba(255,255,255,0.05);
        }
        .log-item { 
            padding: 4px 0; border-bottom: 1px solid rgba(255,255,255,0.05); 
            display: flex; justify-content: flex-start; align-items: center; gap: 8px;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .log-item a { color: inherit; text-decoration: none; border-bottom: 1px dashed rgba(255,255,255,0.3); }
        .log-item a:hover { color: white; border-bottom: 1px solid white; }
        .log-icon { flex-shrink: 0; width: 15px; text-align: center; }
        .log-success { color: #00d2ff; } 
        .log-error { color: #ff4757; } 
        .log-skip { color: #f4b400; } 
        .log-info { color: #ddd; }
        .log-warning { color: #ffa502; font-weight: bold; } 

        .log-size { font-size: 0.7em; color: #888; margin-left: auto; padding-left: 10px; }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: rgba(0,0,0,0.1); }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 3px; }
        
        .swal-table { width: 100%; font-size: 0.9em; margin-top: 10px; border-collapse: collapse; }
        .swal-table td { padding: 5px; border-bottom: 1px solid #333; color: #ddd; text-align: left; }
        .swal-table td:last-child { text-align: right; font-weight: bold; color: #fff; }

        .result-box {
            text-align: left; background: #222; padding: 15px; 
            border-radius: 10px; margin-bottom: 10px; border: 1px solid #333;
        }
        .result-title { color: #00d2ff; font-weight: bold; margin-bottom: 5px; font-size: 0.95rem; }
        .result-info { font-size: 0.85rem; color: #ccc; }
        
        .hidden-input { display: none; margin-top: 10px; }

        /* FOLDER PICKER STYLES */
        .picker-container { text-align: left; max-height: 300px; overflow-y: auto; }
        .picker-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; border-bottom: 1px solid #444; padding-bottom: 5px; }
        .picker-item { 
            padding: 8px; border-radius: 5px; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: background 0.2s;
            border: 1px solid transparent; color: #ddd;
        }
        .picker-item:hover { background: rgba(255,255,255,0.1); }
        .picker-item.selected { background: rgba(0, 210, 255, 0.2); border-color: #00d2ff; }
        .picker-icon { font-size: 1.2rem; }
        .picker-back { cursor: pointer; color: #f4b400; font-weight: bold; margin-right: 10px; }
        .picker-back:hover { text-decoration: underline; }
        .picker-actions { display: flex; gap: 5px; margin-top: 15px; }
        .picker-btn-sm { padding: 8px; font-size: 0.8rem; border-radius: 5px; border:none; cursor: pointer; flex: 1; color: white;}
    </style>
</head>
<body>

<div id="tsparticles"></div>

<div class="container">
    <h1>G-Drive Ultimate</h1>
    <p class="subtitle">Smart Filter & Secure Cloning</p>
    
    <!-- MODE TOGGLE -->
    <div class="mode-switch-container">
        <div class="mode-switch-wrapper">
            <div class="mode-highlighter" id="modeHighlighter"></div>
            <button class="mode-btn active" id="btnSimple" onclick="setMode('simple')">Simple</button>
            <button class="mode-btn" id="btnAdvance" onclick="setMode('advance')">Advance</button>
        </div>
    </div>
    
    <!-- AUTHENTICATION (COMMON) -->
    <div class="form-group">
        <label for="accessPin">PIN Akses (Wajib)</label>
        <input type="password" id="accessPin" placeholder="Masukkan PIN Rahasia Anda" value="12345">
    </div>
    
    <!-- SOURCE LINKS (COMMON) -->
    <div class="form-group">
        <div class="header-row">
            <label for="folderUrls">Daftar Link Sumber</label>
            <button id="clearInputBtn" class="btn-clear">Clear</button>
        </div>
        <textarea id="folderUrls" placeholder="Tempel banyak link di sini (pisahkan dengan koma atau baris baru)..."></textarea>
    </div>

    <!-- DESTINATION (COMMON) -->
    <div class="form-group">
        <label for="destUrl">Folder Tujuan (Opsional)</label>
        <div class="input-group">
            <input type="text" id="destUrl" placeholder="Link folder tujuan (jika kosong = default)">
            <button type="button" class="btn-picker" id="browseBtn">üìÇ Pilih</button>
        </div>
        <div style="font-size:0.75rem; color:#aaa; margin-top:4px;">*Klik "Pilih" untuk mencari folder atau buat baru.</div>
    </div>

    <!-- SUBFOLDER (COMMON) -->
    <div class="form-group">
        <label for="newFolderName">Buat Folder Baru (Sub-folder)</label>
        <input type="text" id="newFolderName" placeholder="Contoh: Gambarku (Dibuat di dalam folder tujuan)">
    </div>

    <!-- ADVANCED SECTION (HIDDEN IN SIMPLE MODE) -->
    <div class="advanced-section" id="advancedSection">
        <div style="font-size:0.8rem; color:#f4b400; margin-bottom:10px; border-bottom:1px solid #444; padding-bottom:5px;">üõ†Ô∏è Pengaturan Advance</div>
        
        <div class="form-group">
            <label for="duplicateMode">Metode Duplikasi:</label>
            <select id="duplicateMode" onchange="toggleRenameInput()">
                <optgroup label="üîµ Mode Copy (File Sumber Tetap Aman)">
                    <option value="copy_duplicate">Copy & Duplikat (Default)</option>
                    <option value="copy_skip">Copy & Skip (Jika file ada, lewati)</option>
                    <option value="copy_replace">Copy & Replace (Timpa file lama)</option>
                </optgroup>
                <optgroup label="‚úèÔ∏è Mode Rename (Ganti Nama Sumber)">
                    <option value="rename_duplicate">Copy & Rename Sumber</option>
                    <option value="rename_skip">Copy & Rename (Skip jika target ada)</option>
                    <option value="rename_replace">Copy & Rename (Replace jika target ada)</option>
                </optgroup>
            </select>
            
            <!-- INPUT UNTUK CUSTOM RENAME -->
            <div id="renameInputContainer" class="hidden-input">
                <input type="text" id="renamePrefix" placeholder="Tulis Prefix Baru (Default: [MOVED])">
                <div style="font-size:0.7em; color:#aaa; margin-top:2px;">*Nama file sumber akan menjadi: <b>Prefix + NamaAsli</b></div>
            </div>
        </div>
        
        <div class="two-col">
            <div class="col">
                <label for="maxSize">Max Size (MB)</label>
                <input type="number" id="maxSize" placeholder="0 = Unlimited" min="0">
            </div>
            <div class="col">
                <label for="ignoredExt">Abaikan Ekstensi</label>
                <input type="text" id="ignoredExt" placeholder="mp4, mkv, exe">
            </div>
        </div>
        <div style="font-size:0.7em; color:#aaa; margin-top:5px; margin-bottom:15px;">*Pisahkan ekstensi dengan koma.</div>

        <div class="form-group">
            <label for="emailNotif">Email Notifikasi</label>
            <input type="email" id="emailNotif" placeholder="email.anda@gmail.com">
        </div>
        
        <div class="toggle-container">
            <span class="toggle-label">Run in Background (Server-Side)</span>
            <label class="switch">
                <input type="checkbox" id="bgToggle">
                <span class="slider"></span>
            </label>
        </div>

        <!-- NEW: QUOTA CHECK BUTTON -->
        <button id="btnQuota" type="button">üìä Cek Sisa Kuota</button>

        <!-- UPDATED: MULTI SCHEDULE SECTION -->
        <div class="schedule-box">
            <div class="schedule-title">üìÖ Manajemen Jadwal Backup</div>
            
            <!-- FORM TAMBAH -->
            <div class="form-group">
                <label for="scheduleLabel">Nama Label Jadwal (Opsional)</label>
                <input type="text" id="scheduleLabel" placeholder="Contoh: Backup Dokumen Kerja">
            </div>
            
            <!-- NEW: RETENTION INPUT -->
            <div class="form-group">
                <label for="maxBackups">Jumlah Max Backup (Retention)</label>
                <input type="number" id="maxBackups" value="30" min="1" max="100">
                <div style="font-size:0.7em; color:#aaa; margin-top:5px;">*Jika jumlah backup > 30, yang terlama dihapus.</div>
            </div>
            
            <button id="addScheduleBtn" type="button">‚ûï Tambahkan ke Daftar Jadwal</button>
            
            <!-- LIST JADWAL -->
            <div class="schedule-list" id="scheduleListContainer">
                <div style="text-align:center; padding:10px; color:#666; font-size:0.8rem;">
                    Memuat daftar jadwal...
                </div>
            </div>
            <div style="text-align:right; margin-top:5px;">
                <button type="button" onclick="refreshScheduleList()" style="background:transparent; border:none; color:#00d2ff; font-size:0.8rem; cursor:pointer; width:auto; display:inline;">üîÑ Refresh List</button>
            </div>
        </div>
    </div>

    <div class="btn-group">
        <button id="checkBtn">üîç Cek Semua Link</button>
        <button id="submitBtn">Mulai Proses</button>
        <button id="stopBtn">STOP üõë</button>
    </div>

    <div class="progress-wrapper" id="progressWrapper">
        <div class="global-status" id="globalStatus">Menunggu...</div>
        <div class="timer-display" id="timerDisplay">00:00:00</div>
        <div style="display:flex; justify-content:space-between; font-size:0.8rem; color:#b8c6db;">
            <span id="progressText">Progress...</span>
            <span id="progressPercent">0%</span>
        </div>
        <div class="progress-container">
            <div class="progress-bar" id="progressBar"></div>
        </div>
        <div class="log-area" id="logArea"></div>
    </div>
</div>

<script>
    // --- GANTI URL INI DENGAN URL WEB APP ANDA ---
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzVMco1a7VA7GkY6OyxFm239RXZlqMsTUy9kheMJthucelNETE9Zu9B9jqMB9mgyWbr/exec"; 
    
    const CONCURRENCY_LIMIT = 5; 

    // UI References
    const submitBtn = document.getElementById('submitBtn');
    const checkBtn = document.getElementById('checkBtn');
    const stopBtn = document.getElementById('stopBtn');
    const bgToggle = document.getElementById('bgToggle');
    const folderUrlsInput = document.getElementById('folderUrls');
    const destUrlInput = document.getElementById('destUrl');
    const browseBtn = document.getElementById('browseBtn'); 
    const newFolderNameInput = document.getElementById('newFolderName'); 
    const clearInputBtn = document.getElementById('clearInputBtn');
    const accessPinInput = document.getElementById('accessPin');
    
    // Mode Switch UI
    const advancedSection = document.getElementById('advancedSection');
    const btnSimple = document.getElementById('btnSimple');
    const btnAdvance = document.getElementById('btnAdvance');
    const modeHighlighter = document.getElementById('modeHighlighter');

    const progressWrapper = document.getElementById('progressWrapper');
    const progressBar = document.getElementById('progressBar');
    const logArea = document.getElementById('logArea');
    const globalStatus = document.getElementById('globalStatus');
    const timerDisplay = document.getElementById('timerDisplay');
    
    // Setting Inputs
    const duplicateModeInput = document.getElementById('duplicateMode');
    const renameInputContainer = document.getElementById('renameInputContainer');
    const renamePrefixInput = document.getElementById('renamePrefix');
    const maxSizeInput = document.getElementById('maxSize');
    const ignoredExtInput = document.getElementById('ignoredExt');
    const emailNotifInput = document.getElementById('emailNotif');
    
    // Multi Schedule Inputs
    const scheduleLabelInput = document.getElementById('scheduleLabel');
    const maxBackupsInput = document.getElementById('maxBackups'); // New Input
    const addScheduleBtn = document.getElementById('addScheduleBtn');
    const scheduleListContainer = document.getElementById('scheduleListContainer');
    const btnQuota = document.getElementById('btnQuota');

    let isStopRequested = false;
    let timerInterval;
    let currentSessionLogs = [];
    
    // Store active schedules locally
    let activeSchedules = [];
    
    // PICKER VARIABLES
    let currentPickerFolderId = 'root';
    let selectedPickerFolder = null;

    // --- INIT ---
    // Load list schedule saat halaman dibuka
    window.addEventListener('DOMContentLoaded', () => {
       refreshScheduleList();
    });
    
    // NEW: Quota Check Listener with Updated UI
    btnQuota.addEventListener('click', async () => {
        Swal.fire({title: 'Mengecek Kuota...', didOpen:()=>{Swal.showLoading()}});
        try {
            const res = await sendRequest({ action: 'check_quota' });
            if (res.status === 'success') {
                const healthColor = res.drivePercent > 90 ? '#ff4757' : (res.drivePercent > 70 ? '#ffa502' : '#2ed573');
                
                let htmlContent = `
                    <div style="text-align:left; color:#fff; background:#222; padding:15px; border-radius:10px;">
                        <div style="margin-bottom:15px; border-bottom:1px solid #444; padding-bottom:10px;">
                            <strong>üìß Email Quota:</strong> <span style="float:right; color:#2ed573;">${res.emailQuota} / hari</span>
                        </div>
                        <div style="margin-bottom:5px;">
                            <strong>‚òÅÔ∏è Drive Storage:</strong>
                        </div>
                        <div style="background:#444; border-radius:10px; overflow:hidden; height:20px; margin-bottom:5px; border:1px solid #555;">
                            <div style="background:${healthColor}; width:${res.drivePercent}%; height:100%; transition:width 0.5s;"></div>
                        </div>
                        <div style="font-size:0.85em; color:#ccc; display:flex; justify-content:space-between;">
                            <span>Terpakai: ${res.driveUsed}</span>
                            <span>Total: ${res.driveLimit} (${res.drivePercent}%)</span>
                        </div>
                    </div>
                `;
                
                Swal.fire({
                    title: 'Status Akun',
                    html: htmlContent,
                    background: '#1a1a2e', color: '#fff',
                    confirmButtonText: 'Tutup'
                });
            } else {
                Swal.fire('Gagal', res.message, 'error');
            }
        } catch(e) {
            Swal.fire('Error', 'Koneksi gagal', 'error');
        }
    });
    
    window.refreshScheduleList = async function() {
        scheduleListContainer.innerHTML = '<div style="text-align:center; padding:10px; color:#aaa; font-size:0.8rem;">Memuat...</div>';
        try {
            // Gunakan PIN default 0000 jika kosong untuk read-only request
            const res = await sendRequest({ action: 'get_schedule_list', pin: accessPinInput.value || '0000' });
            
            if (res.status === 'success') {
                if (res.list && res.list.length > 0) {
                    activeSchedules = res.list; // Simpan ke variable global
                    let html = '';
                    res.list.forEach(item => {
                        const lastRun = item.lastRun ? new Date(item.lastRun).toLocaleString() : 'Belum pernah';
                        html += `
                        <div class="schedule-item">
                            <div class="schedule-info">
                                <span class="schedule-name">${item.label}</span>
                                <div class="schedule-meta">Destinasi: ...${item.destUrl.substr(-15)}</div>
                                <div class="schedule-meta">Mode: ${item.mode} | Run Terakhir: ${lastRun}</div>
                            </div>
                            <div class="sched-btn-group">
                                <button class="btn-detail-sched" onclick="viewScheduleDetail('${item.id}')">‚ÑπÔ∏è Detail</button>
                                <button class="btn-del-sched" onclick="deleteSchedule('${item.id}', '${item.label}')">üóëÔ∏è Hapus</button>
                            </div>
                        </div>`;
                    });
                    scheduleListContainer.innerHTML = html;
                } else {
                    scheduleListContainer.innerHTML = '<div style="text-align:center; padding:10px; color:#666; font-size:0.8rem;">Belum ada jadwal aktif.</div>';
                }
            } else {
                scheduleListContainer.innerHTML = `<div style="color:red; text-align:center;">Gagal: ${res.message}</div>`;
            }
        } catch(e) {
            scheduleListContainer.innerHTML = '<div style="color:red; text-align:center;">Error koneksi.</div>';
        }
    };

    window.viewScheduleDetail = function(id) {
        const item = activeSchedules.find(s => s.id === id);
        if (!item) return;

        const config = item.config;
        const sourceLinksHtml = config.urls.map((u, i) => `<div>${i+1}. <a href="${u}" target="_blank" style="color:#00d2ff; text-decoration:none;">${shortUrl(u)}</a></div>`).join('');
        
        let filterHtml = "Tidak ada filter aktif.";
        if (config.filters && (config.filters.maxSizeMB > 0 || config.filters.ignoredExt)) {
            filterHtml = `Max Size: ${config.filters.maxSizeMB || 'Unlimited'} MB<br>Ignore Ext: ${config.filters.ignoredExt || '-'}`;
        }

        Swal.fire({
            title: `üìã Detail Jadwal`,
            html: `
                <div style="text-align:left; font-size:0.85rem; background:#222; padding:15px; border-radius:8px; border:1px solid #444; max-height:300px; overflow-y:auto;">
                    <div style="margin-bottom:10px;">
                        <strong style="color:#f4b400;">üè∑Ô∏è Label:</strong> ${item.label}
                    </div>
                    <div style="margin-bottom:10px;">
                        <strong style="color:#f4b400;">üîó Link Sumber (${config.urls.length}):</strong>
                        <div style="padding-left:10px; font-size:0.8rem;">${sourceLinksHtml}</div>
                    </div>
                    <div style="margin-bottom:10px;">
                        <strong style="color:#f4b400;">üìÇ Tujuan:</strong><br>
                        <a href="${config.destUrl}" target="_blank" style="color:#00d2ff;">Buka Folder Tujuan</a><br>
                        Sub-folder: ${config.newFolderName || "(Tidak ada)"}
                    </div>
                    <div style="margin-bottom:10px;">
                        <strong style="color:#f4b400;">‚öôÔ∏è Setting:</strong><br>
                        Mode: ${config.mode}<br>
                        Retention (Max): ${config.maxBackups || 30}<br>
                        Email: ${config.email || "-"}
                    </div>
                    <div>
                        <strong style="color:#f4b400;">üîç Filter:</strong><br>
                        ${filterHtml}
                    </div>
                </div>
            `,
            background: '#1a1a2e',
            color: '#fff',
            showConfirmButton: true,
            confirmButtonText: 'Tutup'
        });
    };

    window.deleteSchedule = async function(id, name) {
        const pin = accessPinInput.value;
        if (!pin) { Swal.fire('Error', 'Masukkan PIN untuk menghapus jadwal!', 'error'); return; }

        const confirm = await Swal.fire({
            title: 'Hapus Jadwal?',
            text: `Yakin ingin menghapus jadwal "${name}"?`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'Ya, Hapus!'
        });

        if (confirm.isConfirmed) {
            Swal.fire({title: 'Menghapus...', didOpen:()=>{Swal.showLoading()}});
            try {
                const res = await sendRequest({ action: 'delete_schedule_item', pin: pin, id: id });
                if (res.status === 'success') {
                    Swal.fire('Terhapus', 'Jadwal berhasil dihapus.', 'success');
                    refreshScheduleList();
                } else {
                    Swal.fire('Gagal', res.message, 'error');
                }
            } catch(e) {
                Swal.fire('Error', e.message, 'error');
            }
        }
    };

    // --- MODE TOGGLE FUNCTION ---
    function setMode(mode) {
        if (mode === 'simple') {
            advancedSection.style.display = 'none';
            btnSimple.classList.add('active');
            btnAdvance.classList.remove('active');
            modeHighlighter.style.transform = 'translateX(0%)';
        } else {
            advancedSection.style.display = 'block';
            btnSimple.classList.remove('active');
            btnAdvance.classList.add('active');
            modeHighlighter.style.transform = 'translateX(100%)';
        }
    }
    
    // Default mode
    setMode('simple');
    
    function toggleRenameInput() {
        const mode = duplicateModeInput.value;
        if (mode.startsWith('rename_')) {
            renameInputContainer.style.display = 'block';
        } else {
            renameInputContainer.style.display = 'none';
        }
    }

    clearInputBtn.addEventListener('click', () => { folderUrlsInput.value = ''; folderUrlsInput.focus(); });
    
    // --- ADD SCHEDULE LOGIC ---
    addScheduleBtn.addEventListener('click', async () => {
        const pin = accessPinInput.value;
        if (!pin) { Swal.fire('Error', 'Masukkan PIN untuk menambah jadwal!', 'error'); return; }

        const rawText = folderUrlsInput.value;
        const urls = rawText.split(/[\n,]+/).map(u => u.trim()).filter(u => u.length > 0);
        
        if (urls.length === 0) {
            Swal.fire('Warning', 'Masukkan minimal 1 Link Sumber!', 'warning');
            return;
        }

        let renamePrefix = renamePrefixInput.value.trim();
        if (renamePrefix === "") renamePrefix = "[MOVED] ";
        if (!renamePrefix.endsWith(" ") && !renamePrefix.endsWith("_") && !renamePrefix.endsWith("-")) renamePrefix += " ";

        const config = {
            urls: urls,
            destUrl: destUrlInput.value.trim(),
            newFolderName: newFolderNameInput.value.trim(),
            mode: duplicateModeInput.value,
            renamePrefix: renamePrefix,
            maxBackups: parseInt(maxBackupsInput.value) || 30, // Save Max Backups
            filters: {
                maxSizeMB: parseInt(maxSizeInput.value) || 0,
                ignoredExt: ignoredExtInput.value
            },
            email: emailNotifInput.value
        };
        
        const label = scheduleLabelInput.value.trim() || ("Backup - " + new Date().toLocaleTimeString());

        Swal.fire({title: 'Menambahkan Jadwal...', didOpen:()=>{Swal.showLoading()}});

        try {
            const res = await sendRequest({
                action: 'add_schedule_item',
                pin: pin,
                label: label,
                config: config
            });

            if (res.status === 'success') {
                Swal.fire('Berhasil', 'Jadwal ditambahkan ke antrian harian.', 'success');
                scheduleLabelInput.value = ''; // Reset label
                refreshScheduleList();
            } else {
                Swal.fire('Gagal', res.message, 'error');
            }
        } catch(e) {
            Swal.fire('Error', e.message, 'error');
        }
    });


    // --- FOLDER PICKER LOGIC ---
    browseBtn.addEventListener('click', () => {
        const pin = accessPinInput.value;
        if(!pin) { Swal.fire('Error', 'Masukkan PIN Akses terlebih dahulu!', 'error'); return; }
        openFolderPicker(pin);
    });

    function openFolderPicker(pin) {
        currentPickerFolderId = 'root';
        selectedPickerFolder = null;
        
        Swal.fire({
            title: 'Pilih Folder Tujuan',
            html: `<div id="pickerContent"><div style="color:#aaa;">Memuat folder...</div></div>`,
            showConfirmButton: false,
            showCloseButton: true,
            width: '600px',
            background: '#1a1a2e', color: '#fff',
            didOpen: () => {
                loadPickerContent(currentPickerFolderId, pin);
            }
        });
    }

    async function loadPickerContent(parentId, pin) {
        const container = document.getElementById('pickerContent');
        if(!container) return;
        
        container.innerHTML = '<div style="text-align:center; padding:20px;"><div class="swal2-loading" style="display:block;"></div></div>';
        
        try {
            const res = await sendRequest({ action: 'browse_folders', parentId: parentId, pin: pin });
            
            if(res.status === 'success') {
                let html = `
                    <div class="picker-header">
                        <div style="font-size:0.9rem; font-weight:bold; color:#00d2ff;">üìÇ ${res.currentName}</div>
                        ${res.parentId ? `<div class="picker-back" onclick="navPicker('${res.parentId}', '${pin}')">‚¨Ö Kembali</div>` : ''}
                    </div>
                    <div class="picker-container">`;
                
                if(res.folders.length === 0) {
                    html += `<div style="padding:20px; text-align:center; color:#666;">Folder kosong</div>`;
                } else {
                    res.folders.forEach(f => {
                        html += `
                        <div class="picker-item" onclick="clickPickerItem(this, '${f.id}', '${f.name}')" ondblclick="navPicker('${f.id}', '${pin}')">
                            <span class="picker-icon">üìÅ</span>
                            <span>${f.name}</span>
                        </div>`;
                    });
                }
                
                html += `</div>
                    <div class="picker-actions">
                        <button class="picker-btn-sm" style="background:#444;" onclick="createNewFolderPicker('${res.currentId}', '${pin}')">‚ûï Buat Folder Baru Disini</button>
                        <button class="picker-btn-sm" style="background:#2ed573;" id="selectCurrentBtn" onclick="choosePickerFolder('${res.currentId}', '${res.currentName}')">‚úÖ Pilih Folder Ini ("${res.currentName}")</button>
                    </div>`;
                
                container.innerHTML = html;
            } else {
                container.innerHTML = `<div style="color:red;">Error: ${res.message}</div>`;
            }
        } catch(e) {
            container.innerHTML = `<div style="color:red;">Koneksi Error: ${e.message}</div>`;
        }
    }

    // Fungsi global agar bisa dipanggil dari onclick string HTML
    window.navPicker = (id, pin) => { loadPickerContent(id, pin); };
    
    window.clickPickerItem = (el, id, name) => {
        // Hapus seleksi lama
        document.querySelectorAll('.picker-item').forEach(i => i.classList.remove('selected'));
        // Tambah seleksi baru
        el.classList.add('selected');
        
        // Update tombol pilih
        const btn = document.getElementById('selectCurrentBtn');
        btn.innerText = `‚úÖ Pilih "${name}"`;
        btn.onclick = () => { choosePickerFolder(id, name); };
    };

    window.choosePickerFolder = (id, name) => {
        const url = `https://drive.google.com/drive/folders/${id}`;
        destUrlInput.value = url;
        Swal.close();
        
        // Animasi flash input
        destUrlInput.style.borderColor = '#2ed573';
        setTimeout(() => { destUrlInput.style.borderColor = 'rgba(255, 255, 255, 0.1)'; }, 1000);
    };

    window.createNewFolderPicker = async (parentId, pin) => {
        const { value: folderName } = await Swal.fire({
            title: 'Nama Folder Baru',
            input: 'text',
            inputLabel: 'Dibuat di dalam folder yang sedang terbuka',
            inputPlaceholder: 'Folder Baru',
            showCancelButton: true,
            background: '#222', color: '#fff'
        });

        if (folderName) {
             Swal.fire({title: 'Membuat Folder...', didOpen:()=>{Swal.showLoading()}});
             try {
                 const res = await sendRequest({ 
                     action: 'create_folder_tool', 
                     parentId: parentId, 
                     name: folderName, 
                     pin: pin 
                 });
                 if(res.status === 'success') {
                     // Refresh view
                     loadPickerContent(parentId, pin);
                     Swal.fire({icon: 'success', title: 'Folder Dibuat', text: `Folder "${folderName}" berhasil dibuat!`, timer: 1500, showConfirmButton: false});
                 } else {
                     Swal.fire('Gagal', res.message, 'error');
                 }
             } catch(e) {
                 Swal.fire('Error', e.message, 'error');
             }
        }
    };
    // --- END PICKER LOGIC ---


    // Particles (Visual)
    if (typeof tsParticles !== 'undefined') {
        tsParticles.load("tsparticles", {
            fpsLimit: 60,
            particles: {
                number: { value: 20, density: { enable: true, area: 800 } },
                shape: { type: ["char", "circle"], character: [ { value: ["üìÇ", "üíæ", "üöÄ", "‚ú®", "üìÑ"], font: "Verdana", weight: "400" } ] },
                color: { value: ["#4285F4", "#DB4437", "#F4B400", "#0F9D58", "#ffffff"] },
                opacity: { value: 0.4, random: true }, size: { value: { min: 10, max: 20 }, random: true },
                move: { enable: true, speed: 1, direction: "none", random: true, outModes: { default: "out" } }
            },
            emitters: { rate: { delay: 3, quantity: 1 }, position: { x: 50, y: 50 }, particles: { shape: { type: "char", character: { value: ["‚úâÔ∏è", "üì¶"], font: "Verdana" } }, size: { value: { min: 60, max: 90 } }, opacity: { value: 1 }, move: { enable: true, speed: 1, outModes: { default: "destroy" } } } }
        });
    }

    // --- CHECK FOLDER FUNCTION (MULTI-URL SUPPORT) ---
    checkBtn.addEventListener('click', async () => {
        const rawText = folderUrlsInput.value;
        const urls = rawText.split(/[\n,]+/).map(u => u.trim()).filter(u => u.length > 0);
        const pin = accessPinInput.value;

        if (!pin) { Swal.fire({ icon: 'error', title: 'PIN Kosong', text: 'Masukkan PIN akses Anda.' }); return; }
        if (urls.length === 0) { Swal.fire({ icon: 'warning', title: 'Kosong', text: 'Masukkan setidaknya satu link untuk dicek.' }); return; }

        Swal.fire({ title: `Memindai ${urls.length} Link...`, text: 'Sedang mengambil data...', allowOutsideClick: false, didOpen: () => { Swal.showLoading(); } });

        let resultsHTML = "";
        let hasError = false;

        for (let i = 0; i < urls.length; i++) {
            try {
                const res = await sendRequest({ action: 'check_stats', url: urls[i], pin: pin });
                
                if (res.status === 'success') {
                    // Cek Permission Read Only
                    const accessColor = res.canEdit ? '#2ed573' : '#ff4757'; // Green if Edit, Red if ReadOnly
                    const accessWeight = res.canEdit ? 'normal' : 'bold';

                    resultsHTML += `
                        <div class="result-box">
                            <div class="result-title">${i+1}. ${res.name} (${res.type === 'folder' ? 'üìÅ Folder' : 'üìÑ File'})</div>
                            <div class="result-info">
                                üìÑ File: ${res.stats.files} | 
                                üíæ Size: <span style="color:#2ed573">${res.stats.size}</span><br>
                                üîí Akses: <span style="color:${accessColor}; font-weight:${accessWeight}">${res.access}</span><br>
                                ü§ñ Running As: <span style="color:#fff">${res.scriptUser}</span><br>
                                üëë Owner File: <span style="color:#ccc">${res.ownerEmail}</span>
                            </div>
                        </div>
                    `;
                } else {
                    resultsHTML += `<div class="result-box" style="border-color:#ff4757"><div class="result-title" style="color:#ff4757">${i+1}. Gagal</div><div class="result-info">${res.message}</div></div>`;
                    hasError = true;
                }
            } catch (e) {
                resultsHTML += `<div class="result-box" style="border-color:#ff4757"><div class="result-title" style="color:#ff4757">${i+1}. Error</div><div class="result-info">${e.message}</div></div>`;
            }
        }

        Swal.fire({
            title: 'üìä Hasil Scan Lengkap',
            html: `<div style="max-height:300px; overflow-y:auto; padding-right:5px;">${resultsHTML}</div>`,
            background: '#111', color: '#fff', confirmButtonText: 'Tutup', width: '600px'
        });
    });

    // --- MAIN COPY LOGIC ---

    stopBtn.addEventListener('click', async () => {
        isStopRequested = true; stopBtn.disabled = true; stopBtn.textContent = "Stopping...";
        const pin = accessPinInput.value;
        if (bgToggle.checked) {
            addLog("Mengirim sinyal stop ke server...", "info");
            try { const res = await sendRequest({ action: 'stop_background', pin: pin }); addLog(res.message, "success"); } catch (e) { addLog("Gagal stop: " + e.message, "error"); }
        } else addLog("Menghentikan proses browser...", "info");
        stopTimer();
    });

    submitBtn.addEventListener('click', async () => {
        const rawText = folderUrlsInput.value;
        const urls = rawText.split(/[\n,]+/).map(u => u.trim()).filter(u => u.length > 0);
        const pin = accessPinInput.value;
        const destUrl = destUrlInput.value.trim();
        const newFolderName = newFolderNameInput.value.trim();
        
        // Capture Custom Rename
        let renamePrefix = renamePrefixInput.value.trim();
        if (renamePrefix === "") renamePrefix = "[MOVED] "; // Default value if empty
        // Ensure there is a space at the end if user didn't put one (optional but nice)
        if (!renamePrefix.endsWith(" ") && !renamePrefix.endsWith("_") && !renamePrefix.endsWith("-")) renamePrefix += " ";

        if (!pin) { Swal.fire({ icon: 'error', title: 'PIN Kosong', text: 'Masukkan PIN akses Anda.' }); return; }
        if (urls.length === 0) { Swal.fire({ icon: 'warning', title: 'Kosong', text: 'Masukkan link file/folder!' }); return; }

        // Gather Config
        const config = {
            mode: duplicateModeInput.value,
            destUrl: destUrl,
            newFolderName: newFolderName,
            renamePrefix: renamePrefix, // Send prefix to backend
            filters: {
                maxSizeMB: parseInt(maxSizeInput.value) || 0,
                ignoredExt: ignoredExtInput.value
            },
            email: emailNotifInput.value
        };

        if (config.mode.startsWith('rename_')) {
            const confirmMove = await Swal.fire({
                title: 'Konfirmasi Rename?',
                text: `File sumber akan diganti namanya dengan awalan "${renamePrefix}". Pastikan Anda punya akses Editor!`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Ya, Lanjutkan!',
                cancelButtonText: 'Batal'
            });
            if (!confirmMove.isConfirmed) return;
        }

        isStopRequested = false; setUIState('running'); clearLog(); startTimer();
        
        // Reset logs
        currentSessionLogs = [];

        addLog(`üîê PIN: OK | Mode: ${config.mode.toUpperCase()}`, 'info');
        if (destUrl) addLog(`üìÇ Tujuan Custom: Deteksi URL...`, 'info');
        else addLog(`üìÇ Tujuan: Default Folder`, 'info');
        
        if (newFolderName) addLog(`üìÅ Sub-folder Baru: "${newFolderName}"`, 'info');
        if (config.mode.startsWith('rename_')) addLog(`‚úèÔ∏è Rename Prefix: "${renamePrefix}"`, 'info');

        if (bgToggle.checked) {
            try {
                addLog("Mengirim job ke server...", "info");
                const res = await sendRequest({ 
                    action: 'start_background_multi', 
                    urls: urls, 
                    pin: pin,
                    ...config 
                });
                
                if (res.status === 'success') {
                    addLog("‚úÖ " + res.message, "success"); globalStatus.textContent = "BERJALAN DI SERVER"; 
                    if (typeof launchConfetti === 'function') launchConfetti();
                    Swal.fire({ icon: 'success', title: 'Started!', text: 'Proses berjalan di background. Email akan dikirim saat selesai.', confirmButtonText: 'Oke' });
                } else { 
                    addLog("‚ùå Gagal: " + res.message, "error"); setUIState('stopped'); stopTimer(); 
                    if(res.message.includes("PIN")) Swal.fire({ icon: 'error', title: 'Akses Ditolak', text: 'PIN Salah!' });
                }
            } catch (e) { addLog("‚ùå Error: " + e.message, "error"); setUIState('stopped'); stopTimer(); }
        } else {
            await runForegroundQueue(urls, pin, config);
        }
    });

    async function runForegroundQueue(urls, pin, config) {
        let successCount = 0; let failCount = 0; let grandTotalFiles = 0; let grandTotalBytes = 0; let resultLinks = [];
        let detailedResults = []; // Store per-folder detail

        for (let i = 0; i < urls.length; i++) {
            if (isStopRequested) break;
            const currentUrl = urls[i];
            globalStatus.textContent = `Memproses Link ${i + 1} dari ${urls.length}`;
            updateProgress(0, "Inisialisasi...");

            try {
                addLog(`‚ñ∂ [${i+1}/${urls.length}] Connecting...`, 'info');
                const result = await processSingleFolder(currentUrl, pin, config);
                
                // Add result for later report
                detailedResults.push(result);
                
                const itemType = result.type === 'file' ? 'File' : 'Folder';
                
                if (result.files > 0 || result.type === 'file') {
                     successCount++;
                     addLog(`‚úÖ Selesai: ${itemType} "${result.name}" (${result.files} processed).`, 'success');
                     if (result.url) resultLinks.push({ name: `${itemType}: ${result.name}`, url: result.url });
                } else {
                     addLog(`‚ö†Ô∏è Selesai: ${result.name} (0 file disalin/kena filter).`, 'info');
                }
                
                grandTotalFiles += result.files; 
                grandTotalBytes += parseBytesToNum(result.sizeStr);

            } catch (error) {
                failCount++; addLog(`‚ùå Gagal: ${error.message}`, 'error');
                if(error.message.includes("PIN")) { setUIState('stopped'); stopTimer(); return; }
            }
        }

        setUIState('stopped'); stopTimer();
        
        if (isStopRequested) {
            addLog("‚õî Proses dihentikan.", "error"); globalStatus.textContent = "DIHENTIKAN";
        } else {
            globalStatus.textContent = "SELESAI"; 
            
            addLog("üìù Mencatat Log...", "info");
            try {
                const reportRes = await sendRequest({
                    action: 'send_report',
                    pin: pin,
                    email: config.email || "", 
                    urls: urls,
                    stats: { success: successCount, fail: failCount, totalFiles: grandTotalFiles, totalSize: formatBytes(grandTotalBytes) },
                    details: currentSessionLogs,
                    results: detailedResults // Send detailed results per link
                });
                
                if (reportRes.emailStatus === 'sent') {
                    addLog("üìß Email berhasil terkirim!", "success");
                } else if (reportRes.emailStatus === 'failed') {
                    addLog("‚ö†Ô∏è Gagal kirim email: " + reportRes.emailError, "warning");
                } else {
                    addLog("‚úÖ Log tersimpan (Email: " + reportRes.emailStatus + ")", "success");
                }

                if (typeof launchConfetti === 'function') launchConfetti();
                // Pass sheetUrl to showFinalReport
                showFinalReport(detailedResults, {
                    successCount: successCount,
                    failCount: failCount,
                    totalFiles: grandTotalFiles,
                    totalBytes: grandTotalBytes
                }, reportRes.sheetUrl);

            } catch(e) { console.error("Gagal lapor: ", e); }
        }
    }

    async function processSingleFolder(url, pin, config) {
        if (isStopRequested) return { files: 0, sizeStr: "0 B", url: null, type: 'unknown' };
        
        const initRes = await sendRequest({ action: 'initialize', url: url, name: "", pin: pin, ...config });
        if (initRes.status !== 'success') throw new Error(initRes.message);

        const jobId = initRes.jobId; const total = initRes.totalFiles;
        const sourceName = initRes.sourceName || "Item";
        let targetUrl = initRes.targetUrl; 
        const sourceType = initRes.type || 'folder';

        const actionText = sourceType === 'file' ? 'Menyalin File' : 'Menyalin Folder';
        document.getElementById('progressText').textContent = `${actionText}: ${sourceName}`;

        let finalProcessed = 0; let finalSizeStr = "0 B";

        if (total === 0) {
             // Even if 0 files, we return stats for reporting
             return { 
                 files: 0, 
                 sizeStr: "0 B", 
                 url: targetUrl, 
                 name: sourceName, 
                 type: sourceType,
                 owner: initRes.sourceOwner,
                 status: initRes.sourceStatus,
                 sourceUrl: url
             };
        }

        let isFinished = false; let workers = [];
        
        const workerTask = async () => {
            while (!isFinished && !isStopRequested) {
                try {
                    const res = await sendRequest({ action: 'process_batch', jobId: jobId, pin: pin });
                    if (res.status !== 'success') throw new Error(res.message);
                    
                    const p = res.progress;
                    updateProgress(p.percent, `${actionText}: ${p.processed}/${p.total}`);
                    finalProcessed = p.processed; finalSizeStr = p.currentSize;

                    if (res.processedList && res.processedList.length > 0) {
                        res.processedList.forEach(item => {
                            let type = 'success';
                            if(item.status === 'skipped') type = 'skip';
                            if(item.status === 'error') type = 'error';
                            if(item.status === 'warning') type = 'warning'; 
                            
                            if (item.status === 'success' && sourceType === 'file') targetUrl = item.url;
                            
                            let displayInfo = item.info; 
                            if(item.status === 'warning') displayInfo = "‚ö†Ô∏è " + item.info;

                            // Simpan ke log global untuk dikirim nanti
                            currentSessionLogs.push({
                                name: item.name,
                                url: (item.url && item.url !== '#') ? item.url : 'No Link',
                                status: type.toUpperCase(),
                                info: displayInfo
                            });

                            addLogHTML(item.name, item.url, item.size, type, displayInfo);
                        });
                    }

                    if (res.action === 'complete') isFinished = true;
                } catch (e) { await new Promise(r => setTimeout(r, 2000)); }
            }
        };

        for (let k = 0; k < CONCURRENCY_LIMIT; k++) workers.push(workerTask());
        await Promise.all(workers);

        return { 
            files: finalProcessed, 
            sizeStr: finalSizeStr, 
            url: targetUrl, 
            name: sourceName, 
            type: sourceType,
            owner: initRes.sourceOwner,
            status: initRes.sourceStatus,
            sourceUrl: url
        };
    }

    function showFinalReport(results, grandStats, sheetUrl) {
        // Build the detailed list
        let listHtml = `<div class="report-list-container">`;
        
        results.forEach(res => {
            const statusClass = res.files > 0 ? 'badge-success' : 'badge-skip';
            const statusText = res.files > 0 ? 'Sukses' : '0 File';
            
            listHtml += `
                <div class="report-item">
                    <div style="flex:1;">
                        <div class="report-name">${res.name}</div>
                        <div style="font-size:0.75rem; color:#888;">${res.files} Files | ${res.sizeStr}</div>
                    </div>
                    <div style="text-align:right;">
                        <span class="report-status-badge ${statusClass}">${statusText}</span>
                        ${res.url ? `<br><a href="${res.url}" target="_blank" class="report-link" style="font-size:0.8rem; margin-top:4px; display:inline-block;">üîó Buka</a>` : ''}
                    </div>
                </div>
            `;
        });
        listHtml += `</div>`;

        let sheetBtnHtml = "";
        if (sheetUrl) {
            sheetBtnHtml = `<a href="${sheetUrl}" target="_blank" class="sheet-btn" style="margin-top:15px;">üìÇ Buka Log Sheet Lengkap</a>`;
        }

        Swal.fire({
            title: 'üéâ Laporan Selesai',
            html: `
                <div class="report-grid">
                    <div class="report-stat"><span class="report-val" style="color:#2ed573;">${grandStats.successCount}</span><span class="report-lbl">Sukses</span></div>
                    <div class="report-stat"><span class="report-val" style="color:#ff4757;">${grandStats.failCount}</span><span class="report-lbl">Gagal</span></div>
                    <div class="report-stat"><span class="report-val">${grandStats.totalFiles}</span><span class="report-lbl">Total File</span></div>
                    <div class="report-stat"><span class="report-val">${formatBytes(grandStats.totalBytes)}</span><span class="report-lbl">Total Size</span></div>
                </div>
                ${listHtml}
                ${sheetBtnHtml}
            `,
            background: '#1a1a2e', color: '#fff', 
            confirmButtonText: 'Tutup', confirmButtonColor: '#ff00de',
            allowOutsideClick: false, width: '550px'
        });
    }

    // --- UTILS ---
    function launchConfetti() { if (typeof confetti !== 'undefined') { var d = 3000; var e = Date.now() + d; var i = setInterval(function() { if (Date.now() > e) return clearInterval(i); confetti({ particleCount: 50, spread: 360, startVelocity: 30, origin: { x: Math.random(), y: Math.random() - 0.2 } }); }, 250); } }
    function parseBytesToNum(sizeStr) { if (!sizeStr) return 0; const units = { 'Bytes': 1, 'KB': 1024, 'MB': 1024**2, 'GB': 1024**3, 'TB': 1024**4 }; const parts = sizeStr.split(' '); return parseFloat(parts[0]) * (units[parts[1]] || 1); }
    function formatBytes(bytes) { if (bytes === 0) return '0 Bytes'; const i = Math.floor(Math.log(bytes) / Math.log(1024)); return parseFloat((bytes / Math.pow(1024, i)).toFixed(2)) + ' ' + ['Bytes', 'KB', 'MB', 'GB', 'TB'][i]; }
    async function sendRequest(payload) { const response = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(payload), headers: { 'Content-Type': 'text/plain;charset=utf-8' } }); return await response.json(); }
    function setUIState(state) {
        if (state === 'running') {
            submitBtn.style.display = 'none'; checkBtn.style.display = 'none'; stopBtn.style.display = 'block'; stopBtn.disabled = false; stopBtn.textContent = "STOP üõë";
            folderUrlsInput.disabled = true; destUrlInput.disabled = true; bgToggle.disabled = true; accessPinInput.disabled = true; browseBtn.disabled = true;
            progressWrapper.style.display = 'block'; logArea.style.display = 'block';
        } else {
            submitBtn.style.display = 'block'; checkBtn.style.display = 'block'; stopBtn.style.display = 'none'; folderUrlsInput.disabled = false; destUrlInput.disabled = false; bgToggle.disabled = false; accessPinInput.disabled = false; browseBtn.disabled = false;
        }
    }
    function updateProgress(percent, text) { progressBar.style.width = percent + "%"; document.getElementById('progressPercent').textContent = percent + "%"; document.getElementById('progressText').textContent = text; }
    function addLog(msg, type) { const div = document.createElement('div'); div.className = 'log-item log-' + type; div.innerHTML = `<span class="log-icon">${getIcon(type)}</span> <span>${msg}</span>`; logArea.appendChild(div); logArea.scrollTop = logArea.scrollHeight; }
    
    // Updated to show detail message
    function addLogHTML(name, url, size, type, detailMsg) { 
        const div = document.createElement('div'); 
        div.className = 'log-item log-' + type; 
        const icon = getIcon(type); 
        const content = url && url !== '#' ? `<a href="${url}" target="_blank">${name}</a>` : name; 
        
        let msg = content;
        if(detailMsg && detailMsg !== "Success") msg += ` <span style="font-size:0.8em; opacity:0.8">(${detailMsg})</span>`;

        div.innerHTML = `<span class="log-icon">${icon}</span> <span style="flex:1; overflow:hidden; text-overflow:ellipsis;">${msg}</span> <span class="log-size">${size}</span>`; 
        logArea.appendChild(div); 
        logArea.scrollTop = logArea.scrollHeight; 
    }
    
    function getIcon(type) { if(type === 'success') return '‚úÖ'; if(type === 'error') return '‚ùå'; if(type === 'skip') return '‚è©'; if(type === 'info') return '‚ÑπÔ∏è'; if(type === 'warning') return '‚ö†Ô∏è'; return '‚Ä¢'; }
    function clearLog() { logArea.innerHTML = ''; }
    function shortUrl(url) { return url.length > 40 ? url.substring(0, 35) + "..." : url; }
    function startTimer() { const s = Date.now(); timerDisplay.textContent = "00:00:00"; clearInterval(timerInterval); timerInterval = setInterval(() => { const e = Date.now() - s; const h = Math.floor(e / 3600000); const m = Math.floor((e % 3600000) / 60000); const sec = Math.floor((e % 60000) / 1000); timerDisplay.textContent = `${pad(h)}:${pad(m)}:${pad(sec)}`; }, 1000); }
    function stopTimer() { clearInterval(timerInterval); }
    function pad(n) { return n.toString().padStart(2, '0'); }
</script>

</body>
</html>
